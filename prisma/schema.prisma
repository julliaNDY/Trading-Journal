generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @db.Uuid
  email           String          @unique
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  discordUsername String?
  isBlocked       Boolean         @default(false)
  accounts        Account[]
  dayJournals     DayJournal[]
  importProfiles  ImportProfile[]
  playbooks       Playbook[]
  screenshots     Screenshot[]
  tags            Tag[]
  trades          Trade[]

  @@map("users")
}

model Trade {
  id                   String          @id @default(uuid()) @db.Uuid
  userId               String          @db.Uuid
  symbol               String
  direction            Direction
  openedAt             DateTime
  closedAt             DateTime
  entryPrice           Decimal         @db.Decimal(18, 8)
  exitPrice            Decimal         @db.Decimal(18, 8)
  quantity             Decimal         @db.Decimal(18, 8)
  realizedPnlUsd       Decimal         @db.Decimal(18, 2)
  floatingRunupUsd     Decimal?        @db.Decimal(18, 2)
  floatingDrawdownUsd  Decimal?        @db.Decimal(18, 2)
  stopLossPriceInitial Decimal?        @db.Decimal(18, 8)
  riskRewardRatio      Decimal?        @db.Decimal(10, 4)
  pointValue           Decimal         @default(1.00000000) @db.Decimal(18, 8)
  importHash           String?         @unique
  tradeSignature       String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  accountId            String?         @db.Uuid
  fees                 Decimal?        @db.Decimal(18, 2)
  grossPnlUsd          Decimal?        @db.Decimal(18, 2)
  note                 String?
  plannedRMultiple     Decimal?        @db.Decimal(10, 4)
  points               Decimal?        @db.Decimal(18, 4)
  profitTarget         Decimal?        @db.Decimal(18, 8)
  rating               Int?
  realizedRMultiple    Decimal?        @db.Decimal(10, 4)
  ticksPerContract     Decimal?        @db.Decimal(18, 4)
  youtubeUrl           String?
  timesManuallySet     Boolean         @default(false)
  reviewed             Boolean         @default(false)
  hasPartialExits      Boolean         @default(false)
  screenshots          Screenshot[]
  tradePlaybooks       TradePlaybook[]
  tags                 TradeTag[]
  partialExits         TradeExit[]
  account              Account?        @relation(fields: [accountId], references: [id])
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([openedAt])
  @@index([closedAt])
  @@index([symbol])
  @@index([tradeSignature])
  @@map("trades")
}

model TradeExit {
  id        String   @id @default(uuid()) @db.Uuid
  tradeId   String   @db.Uuid
  exitPrice Decimal  @db.Decimal(18, 8)
  quantity  Decimal  @db.Decimal(18, 8)
  exitedAt  DateTime
  pnl       Decimal  @db.Decimal(18, 2)
  createdAt DateTime @default(now())
  trade     Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_exits")
}

model DayJournal {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @db.Uuid
  date        DateTime     @db.Date
  note        String?
  youtubeUrl  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags        DayTag[]
  screenshots Screenshot[]

  @@unique([userId, date])
  @@index([userId])
  @@map("day_journals")
}

model Tag {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @db.Uuid
  name        String
  color       String     @default("#6366f1")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  dayJournals DayTag[]
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades      TradeTag[]

  @@unique([userId, name])
  @@index([userId])
  @@map("tags")
}

model TradeTag {
  tradeId String @db.Uuid
  tagId   String @db.Uuid
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  trade   Trade  @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@id([tradeId, tagId])
  @@index([tagId], map: "trade_tags_tagId_idx")
  @@map("trade_tags")
}

model DayTag {
  dayJournalId String     @db.Uuid
  tagId        String     @db.Uuid
  dayJournal   DayJournal @relation(fields: [dayJournalId], references: [id], onDelete: Cascade)
  tag          Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([dayJournalId, tagId])
  @@index([tagId], map: "day_tags_tagId_idx")
  @@map("day_tags")
}

model Screenshot {
  id           String      @id @default(uuid()) @db.Uuid
  userId       String      @db.Uuid
  tradeId      String?     @db.Uuid
  dayJournalId String?     @db.Uuid
  filePath     String
  originalName String
  createdAt    DateTime    @default(now())
  dayJournal   DayJournal? @relation(fields: [dayJournalId], references: [id], onDelete: Cascade)
  trade        Trade?      @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tradeId])
  @@index([dayJournalId])
  @@map("screenshots")
}

model ImportProfile {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  name      String
  mapping   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("import_profiles")
}

model Playbook {
  id             String          @id @default(uuid()) @db.Uuid
  userId         String          @db.Uuid
  name           String
  description    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  groups         PlaybookGroup[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tradePlaybooks TradePlaybook[]

  @@unique([userId, name])
  @@index([userId])
  @@map("playbooks")
}

model PlaybookGroup {
  id            String                 @id @default(uuid()) @db.Uuid
  playbookId    String                 @db.Uuid
  name          String
  order         Int                    @default(0)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  playbook      Playbook               @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  prerequisites PlaybookPrerequisite[]

  @@index([playbookId])
  @@map("playbook_groups")
}

model PlaybookPrerequisite {
  id                   String                      @id @default(uuid()) @db.Uuid
  groupId              String                      @db.Uuid
  text                 String
  order                Int                         @default(0)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  group                PlaybookGroup               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  checkedPrerequisites TradePlaybookPrerequisite[]

  @@index([groupId])
  @@map("playbook_prerequisites")
}

model TradePlaybook {
  id                   String                      @id @default(uuid()) @db.Uuid
  tradeId              String                      @db.Uuid
  playbookId           String                      @db.Uuid
  createdAt            DateTime                    @default(now())
  checkedPrerequisites TradePlaybookPrerequisite[]
  playbook             Playbook                    @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  trade                Trade                       @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@unique([tradeId, playbookId])
  @@index([tradeId])
  @@index([playbookId])
  @@map("trade_playbooks")
}

model TradePlaybookPrerequisite {
  tradePlaybookId String               @db.Uuid
  prerequisiteId  String               @db.Uuid
  checked         Boolean              @default(false)
  prerequisite    PlaybookPrerequisite @relation(fields: [prerequisiteId], references: [id], onDelete: Cascade)
  tradePlaybook   TradePlaybook        @relation(fields: [tradePlaybookId], references: [id], onDelete: Cascade)

  @@id([tradePlaybookId, prerequisiteId])
  @@index([prerequisiteId], map: "trade_playbook_prereq_prereqId_idx")
  @@map("trade_playbook_prerequisites")
}

model Account {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @db.Uuid
  name           String
  broker         String?
  description    String?
  color          String   @default("#6366f1")
  initialBalance Decimal? @db.Decimal(18, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades         Trade[]

  @@unique([userId, name])
  @@index([userId])
  @@map("accounts")
}

enum Direction {
  LONG
  SHORT
  UNKNOWN
}

# Story 1.8: Vector DB Production Deployment (Qdrant)

## Status

**üü¢ Ready for Testing** ‚Äî Impl√©mentation compl√®te, tests finaux requis

### R√©sum√©
- ‚úÖ Qdrant Cloud configur√© et connect√©
- ‚úÖ 4 collections cr√©√©es (trades, playbooks, journal_entries, coach_history)
- ‚úÖ 843 embeddings de trades g√©n√©r√©s
- ‚úÖ Backups quotidiens configur√©s (cron API + script)
- ‚úÖ API search fonctionnelle
- ‚è≥ Caching Redis pour queries fr√©quentes (Task 4.5)
- ‚è≥ Alertes latence > 100ms (Task 5.3)

### Ce qui fonctionne
- Collections Qdrant cr√©√©es avec indexes
- Embeddings g√©n√©r√©s via script direct (contourne bug fetch Node.js)
- Backups via `/api/cron/qdrant-backup` ou `scripts/vectordb/backup-collections.ts`

---

## Epic

**Epic 1** : Infrastructure & Foundation (Phase 1)

---

## Story

**As a** platform engineer,  
**I want** to deploy Qdrant Vector DB in production,  
**so that** we have reliable semantic search for trades, playbooks, and AI features.

---

## Background

Phase 0 POC (Story 1.3) validated:
- Qdrant works with Gemini embeddings (768 dims)
- Search latency ~10ms (excellent)
- Embedding generation ~333ms (acceptable)

This story deploys the full production configuration with proper collections and indexes.

---

## Acceptance Criteria

1. **AC1**: Qdrant instance provisioned (Qdrant Cloud or self-hosted).
2. **AC2**: Collections created for all use cases (trades, playbooks, journal, coach).
3. **AC3**: Proper indexes configured for filtering (user_id, symbol, date).
4. **AC4**: Embedding pipeline integrated with AI provider abstraction.
5. **AC5**: Search latency < 50ms (p95).
6. **AC6**: Batch embedding generation working.
7. **AC7**: Collection backups configured.
8. **AC8**: Multi-tenancy support (user isolation).

---

## Tasks / Subtasks

- [x] **Task 1: Provision Qdrant** (AC: 1)
  - [x] 1.1 Evaluate options (Qdrant Cloud vs self-hosted Docker)
  - [x] 1.2 Provision instance (1GB+ for production)
  - [x] 1.3 Configure `QDRANT_URL` and `QDRANT_API_KEY` env variables
  - [x] 1.4 Test connectivity from application

- [x] **Task 2: Create Collections** (AC: 2, 3)
  - [x] 2.1 Create `trades` collection (768 dims, cosine similarity)
  - [x] 2.2 Create `playbooks` collection (768 dims, cosine similarity)
  - [x] 2.3 Create `journal_entries` collection (768 dims, cosine similarity)
  - [x] 2.4 Create `coach_history` collection (768 dims, cosine similarity)
  - [x] 2.5 Configure payload indexes for filtering

- [x] **Task 3: Implement Embedding Pipeline** (AC: 4, 6)
  - [x] 3.1 Create embedding service using `src/lib/embeddings.ts`
  - [x] 3.2 Implement batch embedding generation (max 50 per batch)
  - [x] 3.3 Create background job for embedding generation
  - [x] 3.4 Handle embedding regeneration on content update

- [x] **Task 4: Implement Search Service** (AC: 5, 8)
  - [x] 4.1 Create `VectorSearchService` class
  - [x] 4.2 Implement user-scoped search (multi-tenancy)
  - [x] 4.3 Implement filtered search (by symbol, date range)
  - [x] 4.4 Implement similarity threshold filtering
  - [ ] 4.5 Add caching for frequent queries (TODO: Redis integration) ‚Äî **√Ä faire**

- [x] **Task 5: Backups & Monitoring** (AC: 7) ‚Äî Partiellement compl√©t√©
  - [x] 5.1 Configure collection snapshots (daily) ‚Äî `scripts/vectordb/backup-collections.ts` + `/api/cron/qdrant-backup`
  - [x] 5.2 Set up monitoring for collection size ‚Äî via `/api/vectordb/health`
  - [ ] 5.3 Alert on high search latency (> 100ms) ‚Äî **√Ä faire** (int√©grer avec Story 1.9)

---

## Implementation Details

### Files Created

| File | Description |
|------|-------------|
| `src/lib/qdrant/client.ts` | Qdrant client singleton with full API |
| `src/lib/qdrant/collections.ts` | Collection definitions + filter builders |
| `src/lib/qdrant/index.ts` | Module exports |
| `src/services/vector-search-service.ts` | User-scoped semantic search |
| `src/services/embedding-pipeline-service.ts` | Batch embedding generation |
| `src/app/api/vectordb/health/route.ts` | Health check API |
| `src/app/api/vectordb/search/route.ts` | Search API |
| `src/app/api/cron/qdrant-backup/route.ts` | Cron endpoint pour backups automatiques |
| `scripts/vectordb/setup-production.ts` | Production setup script |
| `scripts/vectordb/generate-embeddings-direct.ts` | Script g√©n√©ration embeddings (http natif) |
| `scripts/vectordb/backup-collections.ts` | Script backup manuel |
| `scripts/vectordb/configure-qdrant.ts` | Script configuration env |
| `docs/ops/qdrant-setup.md` | Documentation setup Qdrant |

### Donn√©es Production (2026-01-17)

- **Collections cr√©√©es** : trades, playbooks, journal_entries, coach_history
- **Embeddings g√©n√©r√©s** : 843 trades
- **Backups** : Configur√©s via cron API

### Usage

```bash
# Setup collections
npx tsx scripts/vectordb/setup-production.ts

# Recreate collections (caution: deletes data)
npx tsx scripts/vectordb/setup-production.ts --recreate

# Test health
curl http://localhost:3000/api/vectordb/health

# Search trades
curl -X POST http://localhost:3000/api/vectordb/search \
  -H "Content-Type: application/json" \
  -d '{"collection": "trades", "query": "winning trade on NQ"}'
```

### Environment Variables

```bash
QDRANT_URL="https://your-cluster.qdrant.io:6333"
QDRANT_API_KEY="your-api-key"
```

---

## Technical Notes

### Collection Schema

```typescript
// Collection configuration
const COLLECTIONS = {
  trades: {
    vectors: { size: 768, distance: 'Cosine' },
    payload_indexes: [
      { field_name: 'user_id', field_schema: 'keyword' },
      { field_name: 'symbol', field_schema: 'keyword' },
      { field_name: 'direction', field_schema: 'keyword' },
      { field_name: 'closed_at', field_schema: 'datetime' },
      { field_name: 'pnl_positive', field_schema: 'bool' },
    ],
  },
  playbooks: {
    vectors: { size: 768, distance: 'Cosine' },
    payload_indexes: [
      { field_name: 'user_id', field_schema: 'keyword' },
      { field_name: 'name', field_schema: 'text' },
      { field_name: 'is_public', field_schema: 'bool' },
    ],
  },
  journal_entries: {
    vectors: { size: 768, distance: 'Cosine' },
    payload_indexes: [
      { field_name: 'user_id', field_schema: 'keyword' },
      { field_name: 'date', field_schema: 'datetime' },
    ],
  },
  coach_history: {
    vectors: { size: 768, distance: 'Cosine' },
    payload_indexes: [
      { field_name: 'user_id', field_schema: 'keyword' },
      { field_name: 'conversation_id', field_schema: 'keyword' },
      { field_name: 'created_at', field_schema: 'datetime' },
    ],
  },
};
```

### Vector Search Service

```typescript
// src/services/vector-search-service.ts
export class VectorSearchService {
  async searchSimilarTrades(
    userId: string,
    queryEmbedding: number[],
    options?: {
      symbol?: string;
      dateRange?: { start: Date; end: Date };
      limit?: number;
      scoreThreshold?: number;
    }
  ): Promise<SimilarTrade[]> {
    const filter = this.buildFilter(userId, options);
    
    const results = await this.qdrantClient.search('trades', {
      vector: queryEmbedding,
      filter,
      limit: options?.limit ?? 10,
      score_threshold: options?.scoreThreshold ?? 0.7,
    });
    
    return results.map(this.mapToTrade);
  }
}
```

---

## Dependencies

- **Requires**: Story 1.3 completed (POC validated)
- **Requires**: Story 1.5 completed (AI provider abstraction)
- **Blocks**: Epic 4 (AI features), Epic 8 (Killer features)

---

## Estimation

- **Effort**: 3-4 days
- **Complexity**: Medium

---

## References

- Story 1.3: `docs/stories/1.3.story.md` (POC)
- Story 1.5: `docs/stories/1.5.story.md` (AI Architecture)
- Qdrant: https://qdrant.tech/documentation/
- Architecture: `docs/architecture-trading-path-journal.md` (Section 2.3.4)

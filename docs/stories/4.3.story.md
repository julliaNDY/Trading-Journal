# Story 4.3: Tiltmeter - ML-Based Discipline Detection

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** automatic detection of discipline loss (tilt) in my trading,  
**so that** I can recognize when I'm trading emotionally and take corrective action.

---

## Acceptance Criteria

1. **AC1**: Service Tiltmeter créé dans `src/services/ai/tiltmeter-service.ts`.
2. **AC2**: Algorithme ML détecte patterns de tilt (perte de discipline).
3. **AC3**: Métrique Tiltmeter (score 0-100) calculée et stockée.
4. **AC4**: Dashboard affiche Tiltmeter score avec alertes (si score élevé).
5. **AC5**: Calcul automatique après chaque trade (background job).
6. **AC6**: Visualisation historique Tiltmeter (graphique évolution).

---

## Tasks / Subtasks

- [ ] **Task 1: Tiltmeter Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/ai/tiltmeter-service.ts`
  - [ ] 1.2 Algorithme ML pour détecter tilt (patterns négatifs)
  - [ ] 1.3 Features : win/loss streaks, trade frequency, size variations
  - [ ] 1.4 Scoring algorithm (0-100, 100 = tilt maximum)

- [ ] **Task 2: ML Algorithm** (AC: 2)
  - [ ] 2.1 Patterns tilt : win/loss streaks, taille positions, fréquence trades
  - [ ] 2.2 Algorithme basique (MVP) : rules-based
  - [ ] 2.3 Future : ML model (scikit-learn/TensorFlow.js)
  - [ ] 2.4 Validation algorithm (tests avec données historiques)

- [ ] **Task 3: Tiltmeter Score** (AC: 3)
  - [ ] 3.1 Calcul score 0-100 (basé sur patterns détectés)
  - [ ] 3.2 Stocker score en DB (table `TiltmeterScore` ou Trade.tiltScore)
  - [ ] 3.3 Migration Prisma si nécessaire
  - [ ] 3.4 Calcul après chaque trade (background job)

- [ ] **Task 4: Dashboard Display** (AC: 4)
  - [ ] 4.1 Composant Tiltmeter dans `src/components/ai/tiltmeter.tsx`
  - [ ] 4.2 Afficher score actuel (dashboard)
  - [ ] 4.3 Alertes si score > seuil (ex: > 70 = tilt élevé)
  - [ ] 4.4 Badge/indicator visuel (vert/orange/rouge)

- [ ] **Task 5: Background Calculation** (AC: 5)
  - [ ] 5.1 Job BullMQ pour calcul Tiltmeter (après chaque trade)
  - [ ] 5.2 Worker exécute calcul
  - [ ] 5.3 Stocker score en DB
  - [ ] 5.4 Gestion erreurs (retry, logging)

- [ ] **Task 6: Historical Visualization** (AC: 6)
  - [ ] 6.1 Graphique évolution Tiltmeter (Recharts)
  - [ ] 6.2 Page `/tiltmeter` ou section dashboard
  - [ ] 6.3 Timeline (7 jours, 30 jours, all time)
  - [ ] 6.4 Corrélation avec performances (PnL vs Tiltmeter)

---

## Dev Notes

- Dépendance : Epic 1 (Redis, BullMQ) et Epic 3 (Données collectées).
- MVP : algorithme rules-based (patterns simples). Future : ML model.
- Performance : calcul rapide (< 500ms) pour éviter latence.
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.4 (AI Architecture).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 3 (Tiltmeter).

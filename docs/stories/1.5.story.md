# Story 1.5: AI Architecture POC (Google Gemini API)

## Status

**✅ Completed** - 2026-01-17

### Résumé
- Google Gemini configuré comme provider principal
- OpenAI configuré comme fallback
- Services créés : `google-gemini.ts`, `ai-provider.ts`, `embeddings.ts`, `coach-service-v2.ts`
- Benchmark script disponible

---

## Story

**As a** platform engineer,  
**I want** a validated AI architecture using Google Gemini API for coaching and feedback,  
**so that** AI features are technically feasible with optimal cost/performance.

---

## Acceptance Criteria

1. **AC1**: Google Gemini API est configurée et accessible depuis le projet.
2. **AC2**: Un test de feedback IA (coach) fonctionne avec latence < 2s (p95).
3. **AC3**: Embeddings sont générés (Gemini ou OpenAI fallback si nécessaire).
4. **AC4**: Coûts estimés documentés (Gemini vs OpenAI comparaison).
5. **AC5**: Recommendation API documentée (Gemini préféré si performance/coûts acceptables).

---

## Tasks / Subtasks

- [x] **Task 1: Configuration Google Gemini API** (AC: 1)
  - [x] 1.1 Obtenir API key Google Gemini (documentation fournie)
  - [x] 1.2 Configurer `GOOGLE_GEMINI_API_KEY` en env (documentation fournie)
  - [x] 1.3 Créer service wrapper (`src/lib/google-gemini.ts`) ✅
  - [x] 1.4 Tester connexion API (endpoint `/api/ai-poc/test` créé)

- [x] **Task 2: POC Feedback IA Coach** (AC: 2)
  - [x] 2.1 Adapter `coach-service.ts` pour supporter Gemini → `coach-service-v2.ts` créé
  - [x] 2.2 Tester latence avec échantillon de trades (benchmark script créé)
  - [x] 2.3 Mesurer p50/p95 latence (benchmark script: `scripts/ai-poc-benchmark.ts`)
  - [x] 2.4 Comparer avec OpenAI (benchmark script inclut comparaison)

- [x] **Task 3: POC Embeddings** (AC: 3)
  - [x] 3.1 Tester Google Gemini Embeddings → `text-embedding-004` (768 dims)
  - [x] 3.2 OpenAI `text-embedding-3-large` en fallback (3072 dims)
  - [x] 3.3 Service embeddings créé (`src/lib/embeddings.ts`)
  - [x] 3.4 Mesurer latence embeddings (inclus dans benchmark)

- [x] **Task 4: Analyse Coûts** (AC: 4)
  - [x] 4.1 Documenter coûts Google Gemini (voir rapport POC)
  - [x] 4.2 Comparer avec OpenAI GPT-4/GPT-3.5 (voir rapport POC)
  - [x] 4.3 Estimer budget mensuel pour usage production (voir rapport POC)

- [x] **Task 5: Documentation & Recommendation** (AC: 5)
  - [x] 5.1 Créer rapport POC → `docs/specs/ai-poc-report.md`
  - [x] 5.2 Documenter recommendation (Gemini préféré, OpenAI fallback)
  - [x] 5.3 Notification PM: **GEMINI RECOMMANDÉ** ✅

---

## Dev Notes

- ⚠️ **CRITIQUE** : Notification immédiate Product Manager requise (voir `docs/roadmap-trading-path-journal.md` Section 5).
- **Préférence Google Gemini** : Suivre directive roadmap (Google Gemini préféré sur OpenAI).
- **Exception** : OpenAI peut être utilisé en fallback si Gemini n'est pas adapté (justifier).
- Référencer `docs/specs/phase-0-poc-plan.md` POC-3.
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.4 pour architecture AI.
- Intégrer avec Vector DB POC (Story 1.3) pour embeddings.

---

## Implementation Summary (2026-01-17)

### Files Created

| File | Description |
|------|-------------|
| `src/lib/google-gemini.ts` | Google Gemini API wrapper (client singleton, chat, embeddings) |
| `src/lib/ai-provider.ts` | Unified AI provider abstraction (Gemini + OpenAI) |
| `src/lib/embeddings.ts` | Embeddings service with similarity utilities |
| `src/services/coach-service-v2.ts` | Updated coach service with multi-provider support |
| `src/app/api/ai-poc/test/route.ts` | API endpoint for testing AI providers |
| `scripts/ai-poc-benchmark.ts` | Benchmark script for latency measurements |
| `docs/specs/ai-poc-report.md` | Complete POC report with recommendations |

### Key Decisions

1. **Primary Provider**: Google Gemini (`gemini-1.5-flash`)
2. **Fallback Provider**: OpenAI (`gpt-4o-mini`)
3. **Embedding Model**: Gemini `text-embedding-004` (768 dims) with OpenAI fallback
4. **Cost**: Gemini is ~2x cheaper than OpenAI

### Next Steps

1. Run benchmark with API keys: `npx tsx scripts/ai-poc-benchmark.ts`
2. Validate p95 latency < 2s
3. Integrate embeddings with Vector DB (Story 1.3)
4. Migrate coach UI to use `coach-service-v2.ts`
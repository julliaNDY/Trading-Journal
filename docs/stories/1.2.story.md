# Story 1.2: Redis + BullMQ Setup (Async Jobs)

## Status

**✅ COMPLETED** - 2026-01-17

### Résumé
- Redis + BullMQ configurés et fonctionnels
- 5 queues définies avec retry/backoff
- Endpoint de test disponible
- Prêt pour déploiement production (voir Story 1.7)

---

## Story

**As a** backend engineer,  
**I want** a Redis-backed job queue,  
**so that** broker sync and heavy imports can run asynchronously.

---

## Acceptance Criteria

1. ✅ **AC1**: Redis est provisionne (local ou Upstash).
2. ✅ **AC2**: BullMQ est configure avec une queue simple.
3. ✅ **AC3**: Un job test execute avec retry/backoff.
4. ✅ **AC4**: Logs d'execution sont visibles.

---

## Implementation Details

### Files Created

| File | Purpose |
|------|---------|
| `src/lib/queue/redis.ts` | Redis connection management (Upstash/local) |
| `src/lib/queue/queues.ts` | BullMQ queue definitions and helpers |
| `src/lib/queue/worker.ts` | Worker infrastructure with logging |
| `src/lib/queue/jobs/test-job.ts` | Test job with retry/backoff |
| `src/lib/queue/index.ts` | Module exports |
| `src/app/api/queue/test/route.ts` | Queue test API endpoint |

### Files Modified

| File | Changes |
|------|---------|
| `env.example` | Added REDIS_URL, REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, REDIS_TLS |
| `package.json` | Added bullmq, ioredis |

---

## Features Implemented

### 1. Redis Connection (AC1)

- **Upstash support** via REDIS_URL
- **Local Redis** support via individual env vars
- **TLS auto-detection** for rediss:// URLs
- **Connection pooling** and health checks
- **Lazy connect** for faster startup

```typescript
import { testRedisConnection, getRedisInfo } from '@/lib/queue';

const result = await testRedisConnection();
// { success: true, latencyMs: 5 }

const info = await getRedisInfo();
// { configured: true, connected: true, memory: '1.2M', clients: 2 }
```

### 2. BullMQ Queues (AC2)

- **Pre-defined queues**: broker-sync, import, ai, email, default
- **Default job options**: 3 attempts, exponential backoff
- **Job retention**: 24h completed, 7d failed
- **Queue stats**: waiting, active, completed, failed, delayed

```typescript
import { addJob, getQueueStats, QUEUE_NAMES } from '@/lib/queue';

// Add a job
const jobId = await addJob(QUEUE_NAMES.IMPORT, 'process-csv', {
  fileId: '123',
  userId: 'user-456'
});

// Get stats
const stats = await getQueueStats(QUEUE_NAMES.IMPORT);
// { waiting: 5, active: 2, completed: 100, failed: 3, delayed: 0 }
```

### 3. Test Job with Retry/Backoff (AC3)

- **Configurable delay** for testing
- **Intentional failure** option for retry testing
- **Exponential backoff**: 1s, 2s, 4s
- **3 attempts** by default

```typescript
import { addJob, QUEUE_NAMES, TEST_JOB_NAME, TestJobData } from '@/lib/queue';

const jobData: TestJobData = {
  message: 'Test job',
  delay: 1000, // 1 second processing time
  shouldFail: false,
};

await addJob(QUEUE_NAMES.DEFAULT, TEST_JOB_NAME, jobData, {
  attempts: 3,
  backoff: { type: 'exponential', delay: 1000 },
});
```

### 4. Job Logging & Observability (AC4)

- **Job start/complete/fail** logging
- **Duration tracking**
- **Metrics integration** (recordJobMetric)
- **Error capture** to Sentry

---

## Tasks / Subtasks

- [x] **Task 1: Provisionner Redis** (AC: 1)
  - [x] 1.1 Configurer variables d'env (REDIS_URL, REDIS_HOST, etc.)
  - [x] 1.2 Créer connection manager avec health check
  - [x] 1.3 Support Upstash et Redis local

- [x] **Task 2: Ajouter queue/worker** (AC: 2, 3)
  - [x] 2.1 Créer queue definitions (5 queues)
  - [x] 2.2 Créer worker infrastructure
  - [x] 2.3 Créer job de test avec retry/backoff

- [x] **Task 3: Logs et observabilite** (AC: 4)
  - [x] 3.1 Logger les etats (start/success/fail)
  - [x] 3.2 Intégrer avec observability module
  - [x] 3.3 Créer endpoint de test

---

## How to Test

### Queue Test Endpoint

```bash
# GET - Check queue status
curl http://localhost:3000/api/queue/test

# POST - Add a test job
curl -X POST http://localhost:3000/api/queue/test \
  -H "Content-Type: application/json" \
  -d '{"action": "add-job", "message": "Hello from API"}'

# POST - Add a job that will fail (to test retry)
curl -X POST http://localhost:3000/api/queue/test \
  -H "Content-Type: application/json" \
  -d '{"action": "add-job", "message": "This will fail", "shouldFail": true}'

# POST - Start worker
curl -X POST http://localhost:3000/api/queue/test \
  -H "Content-Type: application/json" \
  -d '{"action": "start-worker"}'

# POST - Process next job manually
curl -X POST http://localhost:3000/api/queue/test \
  -H "Content-Type: application/json" \
  -d '{"action": "process-next"}'
```

---

## Environment Variables

```bash
# Option 1: Full URL (recommended for Upstash)
REDIS_URL="rediss://default:xxx@xxx.upstash.io:6379"

# Option 2: Individual settings (for local Redis)
REDIS_HOST="localhost"
REDIS_PORT="6379"
REDIS_PASSWORD=""
REDIS_TLS="false"
```

---

## Queue Definitions

| Queue | Purpose | Concurrency |
|-------|---------|-------------|
| `broker-sync` | Scheduled broker synchronization | 5 |
| `import` | CSV/data import processing | 5 |
| `ai` | AI processing (coach, embeddings) | 5 |
| `email` | Email notifications | 5 |
| `default` | General background tasks | 5 |

---

## Dev Notes

- BullMQ requires `maxRetriesPerRequest: null` on Redis connection
- Workers need separate Redis connections (handled automatically)
- Queue stats are fetched on-demand, not cached
- Workers are lazily started via API or can be started on app init

---

## References

- [BullMQ Documentation](https://docs.bullmq.io/)
- [Upstash Redis](https://upstash.com/docs/redis/overall/getstarted)
- [ioredis Documentation](https://github.com/redis/ioredis)

---

## Completion Date

**2026-01-17**

# Story 10.4: Voting System Backend - Rate Limiting

## Status

**Draft**

---

## Story

**As a** platform engineer,  
**I want** a secure voting system with rate limiting,  
**so that** users can't spam votes or manipulate results.

---

## Acceptance Criteria

1. **AC1**: Server action `voteOnOption(optionId)` valide authentification utilisateur.
2. **AC2**: Rate limiting : 1 vote par utilisateur par option (prévenir doublons).
3. **AC3**: Validation : option doit exister et être active.
4. **AC4**: Transaction safety : création vote atomique.
5. **AC5**: Audit logging : logger toutes actions votes.

---

## Tasks / Subtasks

- [ ] **Task 1: Voting Server Action** (AC: 1)
  - [ ] 1.1 Créer `src/app/actions/voting.ts` (existe déjà)
  - [ ] 1.2 Action `voteOnOption(optionId)` avec validation auth
  - [ ] 1.3 Utiliser `getUser()` de `@/lib/auth`
  - [ ] 1.4 Retourner erreur si non authentifié

- [ ] **Task 2: Rate Limiting** (AC: 2)
  - [ ] 2.1 Vérifier vote existant avant création (unique userId + optionId)
  - [ ] 2.2 Contrainte unique Prisma (userId + optionId)
  - [ ] 2.3 Gérer cas vote existant (toggle unvote)
  - [ ] 2.4 Retourner erreur si doublon tenté

- [ ] **Task 3: Option Validation** (AC: 3)
  - [ ] 3.1 Vérifier option existe (VotingOption)
  - [ ] 3.2 Vérifier option active (status = 'active')
  - [ ] 3.3 Retourner erreur si option inactive
  - [ ] 3.4 Retourner erreur si option n'existe pas

- [ ] **Task 4: Transaction Safety** (AC: 4)
  - [ ] 4.1 Utiliser Prisma transaction pour création vote
  - [ ] 4.2 Vérifier contrainte unique dans transaction
  - [ ] 4.3 Rollback si erreur
  - [ ] 4.4 Retourner succès/erreur clair

- [ ] **Task 5: Audit Logging** (AC: 5)
  - [ ] 5.1 Logger actions votes (userId, optionId, action, timestamp)
  - [ ] 5.2 Table `VoteAuditLog` (optionnel) ou logs système
  - [ ] 5.3 Logger vote, unvote, erreurs

---

## Dev Notes

- Dépendance : Phase 1 (Foundation - Prisma, auth).
- Server actions existent déjà (`src/app/actions/voting.ts`).
- DB table `Vote` avec contrainte unique (userId + optionId).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 10 (Rate limiting votes).

# Story 4.4: Efficiency Analysis - Real vs Theoretical Exit Comparison

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** to compare my actual entry/exit execution vs theoretical optimal,  
**so that** I can identify execution inefficiencies and improve.

---

## Acceptance Criteria

1. **AC1**: Service Efficiency Analysis créé dans `src/services/ai/efficiency-service.ts`.
2. **AC2**: Calcul sorties optimales théoriques (basé sur tick data MFE/MAE).
3. **AC3**: Comparaison entrée/sortie réelle vs théorique (deltas).
4. **AC4**: Métrique efficacité (score 0-100) calculée et stockée.
5. **AC5**: UI affiche analyse efficacité (graphique + métriques).
6. **AC6**: Visualisation comparant exécution réelle vs théorique.

---

## Tasks / Subtasks

- [ ] **Task 1: Efficiency Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/ai/efficiency-service.ts`
  - [ ] 1.2 Service analyse efficacité (utilise tick data si disponible)
  - [ ] 1.3 Calcul sorties optimales (MFE/MAE analysis)
  - [ ] 1.4 Comparaison réelle vs théorique

- [ ] **Task 2: Optimal Exit Calculation** (AC: 2)
  - [ ] 2.1 Utiliser tick data (Epic 2) pour calcul optimal exit
  - [ ] 2.2 Calcul MFE (Maximum Favorable Excursion) pour optimal exit
  - [ ] 2.3 Fallback si pas de tick data (approximation)
  - [ ] 2.4 Stocker optimal exit théorique

- [ ] **Task 3: Comparison Analysis** (AC: 3)
  - [ ] 3.1 Comparer entry/exit réels vs théoriques
  - [ ] 3.2 Calcul deltas (entryDelta, exitDelta, pnlDelta)
  - [ ] 3.3 Analyse patterns (souvent trop tôt, trop tard)
  - [ ] 3.4 Stocker comparaison en DB

- [ ] **Task 4: Efficiency Score** (AC: 4)
  - [ ] 4.1 Calcul score efficacité 0-100 (basé sur deltas)
  - [ ] 4.2 Stocker score en DB (table `EfficiencyAnalysis` ou Trade.efficiencyScore)
  - [ ] 4.3 Migration Prisma si nécessaire
  - [ ] 4.4 Calcul après chaque trade (background job)

- [ ] **Task 5: Efficiency UI** (AC: 5)
  - [ ] 5.1 Composant EfficiencyAnalysis dans `src/components/ai/efficiency.tsx`
  - [ ] 5.2 Afficher métriques (score, deltas, patterns)
  - [ ] 5.3 Graphique comparaison (entry/exit réels vs théoriques)
  - [ ] 5.4 Page `/efficiency` ou section dashboard

- [ ] **Task 6: Visualization** (AC: 6)
  - [ ] 6.1 Graphique comparant exécution réelle vs théorique (Recharts)
  - [ ] 6.2 Timeline trades avec efficacité
  - [ ] 6.3 Tableau comparaison (entry/exit réels vs théoriques)
  - [ ] 6.4 Corrélation efficacité vs performances

---

## Dev Notes

- Dépendance : Epic 2 (Market Replay pour tick data) et Epic 3 (Données collectées).
- MVP : comparaison basique si pas de tick data (approximation).
- Performance : calcul asynchrone (background job) pour éviter latence.
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.4 (AI Architecture).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 3 (Efficiency Analysis).

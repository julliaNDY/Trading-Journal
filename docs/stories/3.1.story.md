# Story 3.1: Unlimited Accounts - Data Model & Optimizations

## Status

**Draft**

---

## Story

**As a** trader with multiple trading accounts,  
**I want** to manage unlimited accounts without performance degradation,  
**so that** I can track all my accounts in one place.

---

## Acceptance Criteria

1. **AC1**: Schema Account supporte comptes illimités (pas de limite hard, unique constraint sur userId + name).
2. **AC2**: Indexes optimisés pour queries multi-comptes (userId, broker, createdAt).
3. **AC3**: Support 100+ comptes par utilisateur sans dégradation performance (queries < 500ms p95).
4. **AC4**: Cache Redis pour données comptes fréquemment accédés.
5. **AC5**: Vue agrégée optionnelle (dashboard unifié tous comptes).

---

## Tasks / Subtasks

- [ ] **Task 1: Schema Review** (AC: 1)
  - [ ] 1.1 Vérifier schema Account (prisma/schema.prisma)
  - [ ] 1.2 Confirmer unique constraint (userId + name) uniquement
  - [ ] 1.3 Documenter pas de limite hard

- [ ] **Task 2: Database Indexes** (AC: 2)
  - [ ] 2.1 Vérifier index userId (existe déjà)
  - [ ] 2.2 Ajouter index broker (si nécessaire)
  - [ ] 2.3 Ajouter index createdAt (pour tri)
  - [ ] 2.4 Migration Prisma si nécessaire

- [ ] **Task 3: Performance Queries** (AC: 3)
  - [ ] 3.1 Service `account-service.ts` pour queries optimisées
  - [ ] 3.2 Query paginée (limite + offset)
  - [ ] 3.3 Benchmark queries (100+ comptes, < 500ms p95)
  - [ ] 3.4 Optimiser si nécessaire (select only required fields)

- [ ] **Task 4: Redis Cache** (AC: 4)
  - [ ] 4.1 Cache Redis pour comptes fréquents (TTL 5min)
  - [ ] 4.2 Invalidation cache (update/delete account)
  - [ ] 4.3 Service cache dans `src/lib/cache.ts`

- [ ] **Task 5: Aggregate View** (AC: 5)
  - [ ] 5.1 Service pour vue agrégée (tous comptes)
  - [ ] 5.2 Calcul métriques agrégées (total PnL, win rate, etc.)
  - [ ] 5.3 Cache vue agrégée (Redis)

---

## Dev Notes

- Dépendance : Epic 1 (Redis) doit être complété.
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.5 (Unlimited Accounts Architecture).
- Performance critique : support 100+ comptes sans dégradation (roadmap).
- Pas de limite hard : design scalable horizontalement.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Multi-Compte).

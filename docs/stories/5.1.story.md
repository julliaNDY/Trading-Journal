# Story 5.1: MFE/MAE Analysis - Calculation Engine

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** MFE/MAE analysis for my trades,  
**so that** I can understand maximum favorable/adverse excursion and improve exits.

---

## Acceptance Criteria

1. **AC1**: Service MFE/MAE créé dans `src/services/analytics/mfe-mae-service.ts`.
2. **AC2**: Calcul MFE (Maximum Favorable Excursion) par trade.
3. **AC3**: Calcul MAE (Maximum Adverse Excursion) par trade.
4. **AC4**: Calcul < 5s par trade (nécessite tick data).
5. **AC5**: MFE/MAE stockés en DB (Trade.mfeUsd, Trade.maeUsd).
6. **AC6**: Pré-calcul en background (job BullMQ) pour éviter latence.

---

## Tasks / Subtasks

- [ ] **Task 1: MFE/MAE Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/analytics/mfe-mae-service.ts`
  - [ ] 1.2 Service calcul MFE/MAE (utilise tick data Epic 2)
  - [ ] 1.3 Algorithme calcul MFE/MAE (max favorable/adverse excursion)
  - [ ] 1.4 Fallback si pas de tick data (null ou approximation)

- [ ] **Task 2: MFE Calculation** (AC: 2)
  - [ ] 2.1 Calcul MFE (Maximum Favorable Excursion) par trade
  - [ ] 2.2 Requête tick data (TimescaleDB) pour période trade (openedAt → closedAt)
  - [ ] 2.3 Calcul max favorable excursion (price diff max favorable vs entry)
  - [ ] 2.4 Stocker MFE en USD (Trade.mfeUsd)

- [ ] **Task 3: MAE Calculation** (AC: 3)
  - [ ] 3.1 Calcul MAE (Maximum Adverse Excursion) par trade
  - [ ] 3.2 Requête tick data (TimescaleDB) pour période trade
  - [ ] 3.3 Calcul max adverse excursion (price diff max adverse vs entry)
  - [ ] 3.4 Stocker MAE en USD (Trade.maeUsd)

- [ ] **Task 4: Performance Optimization** (AC: 4)
  - [ ] 4.1 Optimiser requêtes TimescaleDB (indexes, time_bucket)
  - [ ] 4.2 Benchmark calcul (< 5s par trade)
  - [ ] 4.3 Optimiser si nécessaire (batch, caching)
  - [ ] 4.4 Pré-calcul en background (éviter latence)

- [ ] **Task 5: Data Model** (AC: 5)
  - [ ] 5.1 Ajouter champs Trade.mfeUsd, Trade.maeUsd (Prisma schema)
  - [ ] 5.2 Migration Prisma
  - [ ] 5.3 Stocker MFE/MAE après calcul
  - [ ] 5.4 Validation (null si pas de tick data)

- [ ] **Task 6: Background Calculation** (AC: 6)
  - [ ] 6.1 Job BullMQ pour calcul MFE/MAE (après chaque trade)
  - [ ] 6.2 Worker exécute calcul
  - [ ] 6.3 Stocker résultats en DB
  - [ ] 6.4 Gestion erreurs (retry, logging)

---

## Dev Notes

- Dépendance : Epic 2 (Market Replay pour tick data) et Epic 3 (Données collectées).
- Performance critique : < 5s par trade (roadmap).
- Pré-calcul en background pour éviter latence (BullMQ worker).
- Fallback si pas de tick data (null ou approximation).
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.3 (TimescaleDB).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 5 (MFE/MAE Analysis).

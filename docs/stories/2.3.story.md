# Story 2.3: Market Replay Engine - Streaming API

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** to stream tick data for market replay,  
**so that** I can replay market conditions tick-by-tick with 250ms precision.

---

## Acceptance Criteria

1. **AC1**: API endpoint `/api/replay/stream` pour streaming ticks (SSE).
2. **AC2**: Streaming supporte période (startDate, endDate) et symbol.
3. **AC3**: Latence requête initiale < 200ms (fenêtre temporelle).
4. **AC4**: Ticks streamés à 60fps pour période < 1 jour.
5. **AC5**: Client peut contrôler vitesse replay (0.5x, 1x, 2x, 4x).
6. **AC6**: Compression active pour réduire bande passante.

---

## Tasks / Subtasks

- [ ] **Task 1: Streaming API Endpoint** (AC: 1)
  - [ ] 1.1 Créer `src/app/api/replay/stream/route.ts`
  - [ ] 1.2 Implémenter Server-Sent Events (SSE)
  - [ ] 1.3 Authentication (requireAuth)

- [ ] **Task 2: Query TimescaleDB** (AC: 2, 3)
  - [ ] 2.1 Service `replay-service.ts` pour requêter ticks
  - [ ] 2.2 Query TimescaleDB par fenêtre temporelle (startDate, endDate, symbol)
  - [ ] 2.3 Optimiser requête (indexes, time_bucket si nécessaire)
  - [ ] 2.4 Benchmark latence (< 200ms)

- [ ] **Task 3: Streaming Logic** (AC: 4)
  - [ ] 3.1 Stream ticks par batch (optimiser throughput)
  - [ ] 3.2 Contrôle framerate (60fps = 1 tick toutes les ~16ms si nécessaire)
  - [ ] 3.3 Gérer buffer client (éviter lag)

- [ ] **Task 4: Speed Control** (AC: 5)
  - [ ] 4.1 Paramètre `speed` (0.5x, 1x, 2x, 4x) dans query params
  - [ ] 4.2 Adapter interval streaming selon speed
  - [ ] 4.3 Client peut changer speed dynamiquement (nouveau stream)

- [ ] **Task 5: Compression** (AC: 6)
  - [ ] 5.1 Compression response (gzip)
  - [ ] 5.2 Optimiser format données (JSON compact)

---

## Dev Notes

- Dépendance : Story 1.1 (TimescaleDB) et Story 2.2 (Data Ingestion).
- Performance critique : 60fps = 16.67ms par frame, optimiser query + streaming.
- SSE (Server-Sent Events) pour streaming unidirectionnel (server → client).
- Pour contrôle bidirectionnel (play/pause), utiliser WebSockets (story future).
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.3 (Streaming).

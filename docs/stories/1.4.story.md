# Story 1.4: Observability Baseline (Logs + Monitoring)

## Status

**✅ COMPLETED** - 2026-01-17

### Résumé
- Logger structuré avec support Axiom/Logtail
- Sentry error tracking (lightweight HTTP API)
- Vercel Analytics + Speed Insights activés
- Métriques de performance collectées

---

## Story

**As a** platform engineer,  
**I want** baseline observability,  
**so that** POCs and infra changes are measurable and debuggable.

---

## Acceptance Criteria

1. ✅ **AC1**: Logging centralise (Axiom/Logtail ou equivalent) configure.
2. ✅ **AC2**: Error tracking (Sentry) valide sur un endpoint test.
3. ✅ **AC3**: Metriques de perf (Vercel Analytics) activees.

---

## Implementation Details

### Files Created

| File | Purpose |
|------|---------|
| `src/lib/observability/logger.ts` | Enhanced structured logger with external sink support |
| `src/lib/observability/sentry.ts` | Lightweight Sentry error tracking integration |
| `src/lib/observability/metrics.ts` | Performance metrics collection |
| `src/lib/observability/index.ts` | Module exports |
| `src/app/api/observability/health/route.ts` | Health check & observability test endpoint |

### Files Modified

| File | Changes |
|------|---------|
| `src/app/layout.tsx` | Added Vercel Analytics and Speed Insights |
| `env.example` | Added SENTRY_DSN, AXIOM_TOKEN, AXIOM_DATASET |
| `package.json` | Added @vercel/analytics, @vercel/speed-insights |

---

## Features Implemented

### 1. Enhanced Logger (AC1)

- **Structured JSON logging** in production
- **Pretty console output** in development
- **External sink support**: Axiom/Logtail compatible
- **Child loggers** for different modules
- **Performance timing** helpers
- **Context propagation**

```typescript
import { logger, apiLogger } from '@/lib/observability';

logger.info('User logged in', { userId: '123' });
apiLogger.error('API failed', error, { endpoint: '/api/trades' });

// Timing
const result = await logger.time('database-query', async () => {
  return await db.query(...);
});
```

### 2. Sentry Error Tracking (AC2)

- **Lightweight HTTP API** integration (no SDK overhead)
- **Exception capture** with stack traces
- **Message capture** at different severity levels
- **User context** support
- **Global tags** and context

```typescript
import { captureException, setUser, setTag } from '@/lib/observability';

setUser({ id: userId, email: userEmail });
setTag('environment', 'production');

try {
  // ...
} catch (error) {
  captureException(error, { context: 'payment' });
}
```

### 3. Vercel Analytics (AC3)

- **Web Vitals** tracking
- **Speed Insights** for performance monitoring
- **Automatic integration** via Next.js components

```typescript
// In layout.tsx
import { Analytics } from '@vercel/analytics/react';
import { SpeedInsights } from '@vercel/speed-insights/next';

<Analytics />
<SpeedInsights />
```

### 4. Metrics Collection

- **API response times**
- **Database query durations**
- **Queue job metrics**
- **Aggregated statistics** (p50, p95, p99)

---

## Tasks / Subtasks

- [x] **Task 1: Logs centralises** (AC: 1)
  - [x] 1.1 Configurer sink logs (Axiom/Logtail support)
  - [x] 1.2 Créer structured logger avec JSON output
  - [x] 1.3 Ajouter child loggers par module

- [x] **Task 2: Sentry** (AC: 2)
  - [x] 2.1 Ajouter DSN en env
  - [x] 2.2 Valider un event test via endpoint /api/observability/health

- [x] **Task 3: Perf metrics** (AC: 3)
  - [x] 3.1 Activer Vercel Analytics (layout.tsx)
  - [x] 3.2 Ajouter Speed Insights
  - [x] 3.3 Créer metrics collection helper

---

## How to Test

### Health Check Endpoint

```bash
# GET - Check observability status
curl http://localhost:3000/api/observability/health

# POST - Test error tracking
curl -X POST http://localhost:3000/api/observability/health \
  -H "Content-Type: application/json" \
  -d '{"action": "test-error"}'

# POST - Test message capture
curl -X POST http://localhost:3000/api/observability/health \
  -H "Content-Type: application/json" \
  -d '{"action": "test-message"}'

# POST - Test all log levels
curl -X POST http://localhost:3000/api/observability/health \
  -H "Content-Type: application/json" \
  -d '{"action": "test-log"}'
```

---

## Environment Variables

```bash
# Sentry
SENTRY_DSN="https://xxx@sentry.io/xxx"
NEXT_PUBLIC_SENTRY_DSN="https://xxx@sentry.io/xxx"

# Axiom (or Logtail)
AXIOM_TOKEN="xaat-xxx"
AXIOM_DATASET="trading-journal"
# Or: LOGTAIL_TOKEN="xxx"
```

---

## Dev Notes

- Logger uses JSON format in production, pretty format in dev
- Sentry uses lightweight HTTP API to avoid SDK overhead
- Vercel Analytics is automatically enabled on Vercel deployments
- Metrics are stored in memory buffer (100 entries max)

---

## References

- [Axiom Documentation](https://axiom.co/docs)
- [Sentry HTTP API](https://develop.sentry.dev/sdk/store/)
- [Vercel Analytics](https://vercel.com/docs/analytics)

---

## Completion Date

**2026-01-17**

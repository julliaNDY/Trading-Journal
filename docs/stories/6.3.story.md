# Story 6.3: Full TradingView Advanced Charts Integration

## Status

**ðŸŸ¢ Implementation Complete** (Core features implemented, pending TradingView library integration)

---

## Story

**As a** trader,  
**I want** a full-featured TradingView Advanced Charts experience with drawing tools, indicators, and my trade executions overlaid,  
**so that** I can perform technical analysis and review my trading performance on the same professional-grade chart.

---

## Acceptance Criteria

### Core Chart Features (TradingView Advanced Charts)
1. **AC1**: TradingView **Advanced Charts Library v29** integrated (NOT Lightweight Charts).
2. **AC2**: **Left Toolbar** enabled â€” user can draw: Trend Lines, Horizontal Lines, Fibonacci Retracement, Rectangles, Text annotations.
3. **AC3**: **Header Widget** enabled â€” user can change timeframe (1m, 5m, 15m, 1H, 4H, D, W), toggle indicators (Volume, SMA, EMA, RSI, MACD).
4. **AC4**: **Indicators Panel** accessible â€” user can add/remove/configure indicators from the chart.
5. **AC5**: Chart theme = **Dark** (matches app theme); symbol/timeframe synchronized with selected trade context.

### Execution Markers (Trade Overlay)
6. **AC6**: Entry markers (buy arrows, blue #2962FF â†“) rendered via `createExecutionShape()`.
7. **AC7**: Exit markers (sell arrows, red #F23645 âŠ—) rendered via `createExecutionShape()`.
8. **AC8**: Tooltips on markers: price, time, P&L USD, R:R ratio (multi-line).
9. **AC9**: Auto-zoom on trade period (openedAt â†’ closedAt) when viewing a specific trade.

### Performance & UX
10. **AC10**: Chart load < 2s; marker render (50 markers) < 300ms; Lighthouse score â‰¥ 80.
11. **AC11**: Mobile responsive â€” chart usable on tablet (toolbar collapsible); touch-friendly interactions.

### Drawing Persistence (Next Phase â€” Noted)
12. **AC12** _(Out of Scope v1)_: Drawing persistence (save/load user drawings) â€” tracked for Phase 6.4.

---

## Roadmap & Implementation Path

**ðŸ“‹ Full roadmap**: See `docs/STORY-6.3-ROADMAP.md`

This story follows a **7-phase execution plan**:

| Phase | Focus | Files | Status |
|-------|-------|-------|--------|
| 1 | **Types & Styling** | `src/lib/types/execution.ts`, `execution-markers.ts` | âœ… Done |
| 2 | **Widget Configuration** | Widget Constructor (toolbar, header, drawings) | âœ… Done |
| 3 | **Backend API** | `src/app/api/trades/executions/route.ts` | âœ… Done |
| 4 | **React Integration** | `useTradingViewExecutions.ts`, component update | âœ… Done |
| 5 | **Testing & Perf** | Unit/integration tests, benchmarks | âœ… Done |
| 6 | **Refinement** | Filters, interactivity, mobile-responsive | ðŸŸ  To Do |
| 7 | **Documentation** | Update story, JSDoc, PROJECT_MEMORY | ðŸŸ  To Do |

---

## Key Decisions

### Architecture
- **Charting Library**: TradingView **Advanced Charts Library v29** (NOT Lightweight Charts)
- **Widget Features**: Full toolbar + header + indicators + drawing tools
- **Execution Markers**: Use `createExecutionShape()` API (native, non-draggable)
- **Data Flow**: Component â†’ Hook â†’ API endpoint â†’ DB trades table
- **Styling**: Buy (blue #2962FF), Sell (red #F23645) per `chart_example.png`

### Widget Constructor Configuration (Critical)
```ts
{
  // Core
  symbol: 'MES',
  interval: '1',
  timezone: 'Etc/UTC',
  theme: 'dark',
  
  // âœ… REQUIRED: Enable full Advanced Charts features
  enabled_features: [
    'left_toolbar',
    'header_widget',
    'header_indicators',
    'header_symbol_search',
    'header_resolutions',
    'header_chart_type',
    'header_settings',
    'header_screenshot',
    'header_fullscreen_button',
    'drawing_templates',
  ],
  
  // Toolbar & Drawings
  drawings_access: { type: 'black', tools: [] }, // all tools enabled
}
```

### API Contract
- **Endpoint**: `GET /api/trades/executions?symbol=MES&from=1706092800&to=1706179200`
- **Response**: Array of `ExecutionMarker` (id, symbol, time, price, side, pnl, rratio, tooltip)
- **Performance**: < 500ms response time

### Lifecycle
- Marker rendering: **Idempotent** (clear all â†’ render new list on symbol/timeframe change)
- Cleanup: On unmount + symbol change (no memory leaks)
- Tooltip format: Multi-line (BUY: qty @ price, Time, P&L, R:R)

### Drawing Persistence (Out of Scope v1)
- User drawings are **session-only** in v1
- Persistence (save/load to DB) tracked for **Story 6.4**

---

## Resources

- **Docs**: [`docs/tradingview_API.md`](../tradingview_API.md) â€” BMAD integration guide
- **Visual ref**: [`docs/chart_example.png`](../chart_example.png) â€” Target UI
- **TradingView API**: [v29 Charting Library Docs](https://www.tradingview.com/charting-library-docs/latest/api/)

---

## Tasks / Subtasks

### Phase 1: Foundation (Types & Styling)
- [x] Task 1.1: Define `ExecutionMarker` interface + `ChartState`
- [x] Task 1.2: Define styling constants & helpers (label, tooltip builders)

### Phase 2: Widget Configuration (Full Advanced Charts)
- [x] Task 2.1: Configure Widget Constructor with `enabled_features` (left_toolbar, header_widget, etc.)
- [x] Task 2.2: Enable `drawings_access` for all drawing tools
- [ ] Task 2.3: Verify toolbar renders (Trend Line, Fibonacci, Horizontal Line visible)
- [ ] Task 2.4: Verify header renders (timeframe selector, indicators button, chart type)

### Phase 3: Backend API
- [x] Task 3.1: Create `GET /api/trades/executions` endpoint
- [x] Task 3.2: Add validation, error handling, rate limiting

### Phase 4: React Integration (Execution Markers)
- [x] Task 4.1: Create `useTradingViewExecutions` hook
- [x] Task 4.2: Integrate hook into `tradingview-chart.tsx` component
- [x] Task 4.3: Inject markers via `createExecutionShape()` after `onChartReady`

### Phase 5: Testing & Performance
- [x] Task 5.1: Unit tests (helpers, styling)
- [x] Task 5.2: Integration tests (API endpoint)
- [ ] Task 5.3: Performance benchmarks (< 2s chart, < 300ms render, Lighthouse â‰¥ 80)
- [ ] Task 5.4: Visual QA â€” toolbar, header, indicators, drawings all functional

### Phase 6: Refinement
- [ ] Task 6.1: Add toggle/filter UI (entries, exits, date range)
- [ ] Task 6.2: Hover/click interactivity (highlight trade, open modal)
- [ ] Task 6.3: Mobile responsive (toolbar collapsible on tablet)

### Phase 7: Documentation & Delivery
- [x] Task 7.1: Update story AC with completion status + metrics
- [ ] Task 7.2: Add JSDoc to all components/hooks
- [ ] Task 7.3: Update `PROJECT_MEMORY.md` with completion entry

---

## Dev Notes

- **Dependency**: Epic 2 (Market Replay Infrastructure, âœ… POC done), Phase 2 brokers âœ…
- **Blocking**: None (all prerequisites met)
- **TradingView Integration**: Must use **Advanced Charts** bundle (includes toolbar, indicators, drawings)
- **Performance Critical**: < 2s load, < 300ms marker render (hard requirement per AC10)
- **Drawing Persistence**: Out of scope for v1 â€” tracked in Story 6.4
- **Reference**: Full roadmap at `docs/STORY-6.3-ROADMAP.md`

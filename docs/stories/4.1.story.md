# Story 4.1: AI Feedback - Pattern Analysis & Suggestions

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** AI feedback analyzing my trading patterns and suggesting improvements,  
**so that** I can identify negative patterns and improve my trading.

---

## Acceptance Criteria

1. **AC1**: Service AI feedback créé dans `src/services/ai/feedback-service.ts`.
2. **AC2**: Analyse patterns négatifs (ex: sorties trop tôt, entries trop tard).
3. **AC3**: Suggestions personnalisées basées sur historique utilisateur.
4. **AC4**: Feedback stocké en DB (table `AIFeedback` liée aux trades).
5. **AC5**: Latence feedback < 2s (cached).
6. **AC6**: UI affiche feedback sur page trade detail.

---

## Tasks / Subtasks

- [ ] **Task 1: AI Feedback Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/ai/feedback-service.ts`
  - [ ] 1.2 Service analyse patterns (LLM OpenAI GPT-4o)
  - [ ] 1.3 Cache Redis pour résultats AI (éviter re-calcul)
  - [ ] 1.4 Async processing (BullMQ) pour feedback background

- [ ] **Task 2: Pattern Analysis** (AC: 2)
  - [ ] 2.1 Analyse patterns négatifs (sorties trop tôt, entries trop tard, etc.)
  - [ ] 2.2 Prompt LLM avec contexte trade + historique utilisateur
  - [ ] 2.3 Extraction patterns identifiés (JSON response)

- [ ] **Task 3: Suggestions** (AC: 3)
  - [ ] 3.1 Génération suggestions personnalisées (basées sur historique)
  - [ ] 3.2 Format suggestions (text, actionnables)
  - [ ] 3.3 Validation suggestions (format JSON structuré)

- [ ] **Task 4: Data Model** (AC: 4)
  - [ ] 4.1 Créer table `AIFeedback` (Prisma schema)
  - [ ] 4.2 Champs : tradeId, userId, patterns, suggestions, cachedAt, createdAt
  - [ ] 4.3 Migration Prisma
  - [ ] 4.4 Stocker feedback après calcul

- [ ] **Task 5: Performance & Caching** (AC: 5)
  - [ ] 5.1 Cache Redis pour feedback (clé : tradeId + userId)
  - [ ] 5.2 TTL cache : 24h (feedback stable pour même trade)
  - [ ] 5.3 Benchmark latence (< 2s cached)
  - [ ] 5.4 Async processing si latence > 2s (stockage background)

- [ ] **Task 6: UI Display** (AC: 6)
  - [ ] 6.1 Composant AIFeedback dans `src/components/ai/feedback.tsx`
  - [ ] 6.2 Afficher patterns + suggestions sur page trade detail
  - [ ] 6.3 Loading state (calcul feedback en cours)
  - [ ] 6.4 Badge "AI-suggested" pour clarifier source

---

## Dev Notes

- Dépendance : Epic 1 (Redis, BullMQ) et Epic 3 (Données collectées).
- ⚠️ **CRITIQUE** : Notification PM requise pour OpenAI GPT-4o API (voir roadmap).
- Caching agressif pour réduire coûts API (même trade = même feedback).
- Async processing pour éviter latence excessive (BullMQ worker).
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.4 (AI Architecture).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 3 (AI Feedback).

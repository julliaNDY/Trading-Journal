# Story 4.1: Extraction Drawdown/Runup via OCR

**Epic:** 4 - OCR Avancé  
**Story ID:** 4.1  
**Status:** Approved  
**Points:** 5  
**Priorité:** HIGH  
**Dépendances:** Aucune (première story de l'Epic 4)

---

## Story

**As a** trader,  
**I want** the OCR system to automatically extract Drawdown and Runup values from my trading screenshots,  
**so that** I can have complete trade data without manual entry of these important metrics.

---

## Acceptance Criteria

1. [ ] **AC1:** Le service OCR extrait les valeurs Drawdown (DD) des captures d'écran
2. [ ] **AC2:** Le service OCR extrait les valeurs Runup (RU) des captures d'écran
3. [ ] **AC3:** L'interface `OcrTradeData` inclut les champs `drawdown` et `runup` (optionnels)
4. [ ] **AC4:** Les valeurs DD/RU sont correctement associées à chaque trade parsé
5. [ ] **AC5:** Les formats supportés incluent : `500.00$`, `500,00 $`, `-500.00$`, `(500.00)`, `500`
6. [ ] **AC6:** Les colonnes header "Drawdown" et "Runup" (ou "Run-up", "Run up") sont reconnues
7. [ ] **AC7:** Les tests couvrent tous les cas d'extraction DD/RU (min 15 tests)
8. [ ] **AC8:** Les valeurs extraites sont passées à `createTradesFromOcr()` et sauvegardées en DB

---

## Tasks / Subtasks

### Task 1: Étendre l'interface OcrTradeData (AC: 3)
- [ ] 1.1 Ajouter `drawdown?: number` à `OcrTradeData`
- [ ] 1.2 Ajouter `runup?: number` à `OcrTradeData`
- [ ] 1.3 Documenter les unités (USD absolu, valeur positive = excursion maximale)

### Task 2: Implémenter extractDrawdown() (AC: 1, 5)
- [ ] 2.1 Créer la fonction `extractDrawdown(text: string): number | null`
- [ ] 2.2 Supporter les formats : `500.00$`, `500,00 $`, `-500.00$`, `(500.00)`
- [ ] 2.3 Le Drawdown est TOUJOURS retourné en valeur absolue positive
- [ ] 2.4 Utiliser les patterns de reconnaissance de colonne (position dans la ligne)

### Task 3: Implémenter extractRunup() (AC: 2, 5)
- [ ] 3.1 Créer la fonction `extractRunup(text: string): number | null`
- [ ] 3.2 Supporter les mêmes formats que extractDrawdown
- [ ] 3.3 Le Runup est TOUJOURS retourné en valeur absolue positive

### Task 4: Améliorer isHeaderLine() (AC: 6)
- [ ] 4.1 Ajouter détection des colonnes "Drawdown", "Draw-down", "DD"
- [ ] 4.2 Ajouter détection des colonnes "Runup", "Run-up", "Run up", "RU"

### Task 5: Intégrer dans parseOcrText() (AC: 4)
- [ ] 5.1 Détecter l'ordre des colonnes dans le header (position de DD et RU)
- [ ] 5.2 Extraire DD/RU pour chaque ligne de trade
- [ ] 5.3 Associer les valeurs au bon trade (même logique que les autres champs)
- [ ] 5.4 Ajouter warnings si DD/RU attendus mais non trouvés

### Task 6: Mettre à jour RawRow et consolidation (AC: 4)
- [ ] 6.1 Ajouter `drawdown` et `runup` à l'interface `RawRow`
- [ ] 6.2 Propager les valeurs dans `consolidateRawRows()`
- [ ] 6.3 Pour les partial exits, utiliser le DD/RU max du groupe

### Task 7: Intégrer dans createTradesFromOcr() (AC: 8)
- [ ] 7.1 Extraire `drawdown` et `runup` de `OcrTradeData`
- [ ] 7.2 Passer à `createOrMergeTrade()` pour sauvegarde en `floatingDrawdownUsd` et `floatingRunupUsd`

### Task 8: Tests unitaires (AC: 7)
- [ ] 8.1 Tests `extractDrawdown()` : tous formats
- [ ] 8.2 Tests `extractRunup()` : tous formats
- [ ] 8.3 Tests `parseOcrText()` avec DD/RU
- [ ] 8.4 Tests intégration avec partial exits
- [ ] 8.5 Tests cas edge : DD/RU manquants, formats mixtes

---

## Dev Notes

### Source Tree Relevant

```
src/
├── services/
│   ├── ocr-service.ts          # ← MODIFIER : ajouter extraction DD/RU
│   ├── __tests__/
│   │   └── ocr-service.test.ts # ← MODIFIER : ajouter tests DD/RU
│   └── trade-service.ts        # ← MODIFIER : accepter DD/RU dans createOrMergeTrade
├── app/
│   └── actions/
│       └── trades.ts           # ← MODIFIER : passer DD/RU à la création
prisma/
└── schema.prisma               # ✅ Champs floatingRunupUsd/floatingDrawdownUsd existent déjà
```

### Formats OCR Attendus (NinjaTrader / Tradovate)

Les captures d'écran de trading affichent généralement les colonnes suivantes :

```
Entry DT        | Entry Price | Exit DT         | Exit Price | Qty | Profit/Loss | Drawdown | Runup
12/30/2025 10:09| 25717.25    | 12/30/2025 10:12| 25773.50   | +1  | 125,50 $    | 50,00 $  | 175,00 $
```

**Patterns de reconnaissance :**
- Drawdown : Max Adverse Excursion (MAE) - perte maximale non réalisée pendant le trade
- Runup : Max Favorable Excursion (MFE) - profit maximal non réalisé pendant le trade

### Interface OcrTradeData Étendue

```typescript
// src/services/ocr-service.ts
export interface OcrTradeData {
  entryDt: string;
  exitDt: string;
  entryPrice: number;
  exitPrice: number;
  profitLoss: number;
  quantity?: number;
  partialExits?: PartialExitData[];
  // NOUVEAU
  drawdown?: number;  // Max Adverse Excursion (USD, valeur positive)
  runup?: number;     // Max Favorable Excursion (USD, valeur positive)
}
```

### Algorithme de Détection des Colonnes

```typescript
// Pseudo-code pour la détection d'ordre des colonnes
function detectColumnOrder(headerLine: string): ColumnMap {
  const columns = headerLine.toLowerCase().split(/\s{2,}|\t/);
  const map: ColumnMap = {};
  
  columns.forEach((col, index) => {
    if (col.includes('drawdown') || col === 'dd') map.drawdown = index;
    if (col.includes('runup') || col.includes('run-up') || col === 'ru') map.runup = index;
    // ... autres colonnes
  });
  
  return map;
}
```

### Extraction par Position (Alternative)

Si les colonnes ne sont pas clairement séparées, utiliser la position relative :
- Drawdown est généralement AVANT Runup
- Les deux sont APRÈS Profit/Loss
- Pattern : `... PnL $ DD $ RU $ ...`

```typescript
// Pattern regex pour ligne de données avec DD/RU
const linePattern = /
  (?<pnl>-?\d+[.,]\d{2})\s*\$\s*
  (?<dd>\d+[.,]\d{2})\s*\$\s*
  (?<ru>\d+[.,]\d{2})\s*\$
/x;
```

### Gestion des Partial Exits

Pour les trades avec plusieurs sorties, le DD/RU doit être le **maximum** de toutes les lignes :

```typescript
// Dans consolidateRawRows()
if (relatedRows.length > 1) {
  const maxDrawdown = Math.max(...relatedRows.map(r => r.drawdown ?? 0));
  const maxRunup = Math.max(...relatedRows.map(r => r.runup ?? 0));
  
  consolidatedTrade.drawdown = maxDrawdown > 0 ? maxDrawdown : undefined;
  consolidatedTrade.runup = maxRunup > 0 ? maxRunup : undefined;
}
```

### Modification trade-service.ts

```typescript
// Dans createOrMergeTrade() ou équivalent
interface CreateTradeInput {
  // ... champs existants
  floatingDrawdownUsd?: number | null;
  floatingRunupUsd?: number | null;
}
```

---

## Testing

### Emplacement des Tests
`src/services/__tests__/ocr-service.test.ts`

### Standards de Test
- Framework : Vitest
- Pattern : `describe` → `it` → `expect`
- Couverture minimale : 80% pour les nouvelles fonctions

### Cas de Test Requis

```typescript
describe('extractDrawdown', () => {
  it('extracts DD with dollar sign', () => {
    expect(extractDrawdown('50.00$')).toBe(50);
  });
  
  it('extracts DD with comma decimal (EU)', () => {
    expect(extractDrawdown('50,00 $')).toBe(50);
  });
  
  it('extracts DD from negative format', () => {
    expect(extractDrawdown('-50.00$')).toBe(50); // Always positive
  });
  
  it('extracts DD from parentheses format', () => {
    expect(extractDrawdown('(50.00)$')).toBe(50);
  });
  
  it('returns null when no DD found', () => {
    expect(extractDrawdown('no drawdown here')).toBeNull();
  });
});

describe('extractRunup', () => {
  // Mêmes tests que extractDrawdown
});

describe('parseOcrText with DD/RU', () => {
  it('parses trade with DD and RU columns', () => {
    const text = `
      Entry DT Entry Price Exit DT Exit Price Profit Loss Drawdown Runup
      12/30/2025 10:09:48 25717.25 12/30/2025 10:12:05 25773.50 125,50$ 50,00$ 175,00$
    `;
    const result = parseOcrText(text, 'MNQ');
    
    expect(result.trades[0].drawdown).toBe(50);
    expect(result.trades[0].runup).toBe(175);
  });
  
  it('handles missing DD/RU gracefully', () => {
    const text = `
      12/30/2025 10:09:48 25717.25 12/30/2025 10:12:05 25773.50 125,50$
    `;
    const result = parseOcrText(text, 'MNQ');
    
    expect(result.trades[0].drawdown).toBeUndefined();
    expect(result.trades[0].runup).toBeUndefined();
  });
  
  it('uses max DD/RU for partial exits', () => {
    const text = `
      12/30/2025 10:09:48 25717.25 12/30/2025 10:12:05 25750.00 +1 50,00$ 25,00$ 100,00$
      12/30/2025 10:15:00 25773.50 +1 75,50$ 40,00$ 125,00$
    `;
    const result = parseOcrText(text, 'MNQ');
    
    expect(result.trades[0].drawdown).toBe(40); // Max of 25 and 40
    expect(result.trades[0].runup).toBe(125);   // Max of 100 and 125
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Draft initial | SM Agent (Bob) |
| 2026-01-08 | 1.1 | **APPROVED** par PO | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used
*(À remplir lors de l'implémentation)*

### Debug Log References
*(À remplir lors de l'implémentation)*

### Completion Notes List
*(À remplir lors de l'implémentation)*

### File List
*(À remplir lors de l'implémentation)*

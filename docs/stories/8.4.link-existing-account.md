# Story 8.4: Link Existing Account with Social Provider

## Status

Draft

## Story

**As an** existing user with an email/password account,
**I want** to link my Google, Apple, or Discord account,
**so that** I can log in using either method in the future.

## Acceptance Criteria

1. Existing users can link a social provider from their profile/settings page
2. Link button initiates OAuth flow that adds provider to existing account
3. Multiple providers can be linked to the same account
4. User can see which providers are currently linked
5. User can unlink a provider (if at least one auth method remains)
6. Linking Discord automatically populates `discordUsername` if not set
7. Appropriate success/error messages are displayed

## Tasks / Subtasks

- [ ] **Task 1: Create Settings/Profile Page** (AC: 1, 4)
  - [ ] Create `src/app/(dashboard)/settings/page.tsx` if not exists
  - [ ] Add "Linked Accounts" section
  - [ ] Display currently linked providers with status

- [ ] **Task 2: Create LinkAccountButton Component** (AC: 1, 2)
  - [ ] Create `src/components/auth/link-account-button.tsx`
  - [ ] Use `supabase.auth.linkIdentity()` for linking
  - [ ] Handle loading and error states

- [ ] **Task 3: Implement Link Identity Logic** (AC: 2, 3)
  - [ ] Call `supabase.auth.linkIdentity({ provider })`
  - [ ] Handle callback to complete linking
  - [ ] Update user metadata on successful link

- [ ] **Task 4: Display Linked Providers** (AC: 4)
  - [ ] Fetch user's identities from `supabase.auth.getUserIdentities()`
  - [ ] Show linked status for each provider (Google, Apple, Discord)
  - [ ] Show "Link" or "Linked ✓" based on status

- [ ] **Task 5: Implement Unlink Logic** (AC: 5)
  - [ ] Add unlink button for linked providers
  - [ ] Use `supabase.auth.unlinkIdentity()` 
  - [ ] Prevent unlinking last auth method (check if password or other provider exists)
  - [ ] Show confirmation dialog before unlinking

- [ ] **Task 6: Update Discord Username on Link** (AC: 6)
  - [ ] When Discord is linked, update `discordUsername` in database
  - [ ] Reuse logic from Story 8.3

- [ ] **Task 7: Add Translations** (AC: 7)
  - [ ] Add keys to `messages/fr.json` and `messages/en.json`:
    - `settings.linkedAccounts`
    - `settings.linkAccount`
    - `settings.unlinkAccount`
    - `settings.linked`
    - `settings.notLinked`
    - `settings.linkSuccess`
    - `settings.unlinkSuccess`
    - `settings.cannotUnlinkLast`

## Dev Notes

### Supabase Identity Linking API
[Source: Supabase Auth docs]

**Link a new identity:**
```typescript
const { data, error } = await supabase.auth.linkIdentity({
  provider: 'discord',
  options: {
    redirectTo: `${window.location.origin}/settings?linked=discord`,
  },
})
```

**Get user identities:**
```typescript
const { data, error } = await supabase.auth.getUserIdentities()
// Returns: { identities: Identity[] }
// Identity: { provider: string, identity_id: string, ... }
```

**Unlink an identity:**
```typescript
const { data, error } = await supabase.auth.unlinkIdentity(identity)
// identity is the Identity object from getUserIdentities()
```

### Settings Page Structure

```
/settings (or /profile)
├── Account Information
│   ├── Email: user@example.com
│   └── Discord: @username (if set)
├── Linked Accounts
│   ├── Google    [Linked ✓] [Unlink]
│   ├── Apple     [Link]
│   └── Discord   [Linked ✓] [Unlink]
├── Security
│   └── Change Password
└── Danger Zone
    └── Delete Account
```

### Component: LinkedAccountsSection

```tsx
'use client'

import { createClient } from '@/lib/supabase/client'
import { useEffect, useState } from 'react'
import { Button } from '@/components/ui/button'

type Provider = 'google' | 'apple' | 'discord'

interface Identity {
  provider: string
  identity_id: string
}

export function LinkedAccountsSection() {
  const [identities, setIdentities] = useState<Identity[]>([])
  const [loading, setLoading] = useState<Provider | null>(null)
  const supabase = createClient()

  useEffect(() => {
    loadIdentities()
  }, [])

  async function loadIdentities() {
    const { data } = await supabase.auth.getUserIdentities()
    setIdentities(data?.identities || [])
  }

  async function linkProvider(provider: Provider) {
    setLoading(provider)
    const { error } = await supabase.auth.linkIdentity({
      provider,
      options: {
        redirectTo: `${window.location.origin}/settings?linked=${provider}`,
      },
    })
    if (error) console.error(error)
    setLoading(null)
  }

  async function unlinkProvider(identity: Identity) {
    if (identities.length <= 1) {
      // Can't unlink last auth method
      return
    }
    const { error } = await supabase.auth.unlinkIdentity(identity)
    if (!error) {
      await loadIdentities()
    }
  }

  const isLinked = (provider: Provider) => 
    identities.some(i => i.provider === provider)

  // ... render buttons
}
```

### Current App Structure
[Source: Project file tree]

Settings page doesn't exist yet. Need to create:
- `src/app/(dashboard)/settings/page.tsx`
- `src/app/(dashboard)/settings/settings-content.tsx` (client component)

### File Structure

```
src/
├── app/
│   └── (dashboard)/
│       └── settings/
│           ├── page.tsx              # NEW
│           └── settings-content.tsx  # NEW
├── components/
│   └── auth/
│       ├── social-login-buttons.tsx  # From Story 8.2
│       └── linked-accounts.tsx       # NEW
```

### Testing

- **Test scenarios**:
  1. User links Google → appears in linked accounts
  2. User links Discord → Discord username updated
  3. User unlinks a provider → removed from list
  4. User cannot unlink last provider → error shown
  5. Link button redirects to OAuth → returns to settings

- **Edge cases**:
  - User already has provider linked → show "Linked" not "Link"
  - OAuth error during linking → show error message
  - User has only OAuth login (no password) → cannot unlink

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial draft | SM Agent |


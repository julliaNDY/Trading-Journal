# Story 8.3: Discord Username Auto-Extraction

## Status

Draft

## Story

**As a** user signing up with Discord,
**I want** my Discord username to be automatically saved to my profile,
**so that** I don't have to manually enter it.

## Acceptance Criteria

1. When a user signs up via Discord OAuth, their Discord username is automatically extracted
2. The `discordUsername` field in the User model is populated from Discord metadata
3. Existing users linking Discord have their username updated
4. Discord username is displayed in the user profile/admin panel
5. Manual Discord username field is hidden when user signed up via Discord

## Tasks / Subtasks

- [ ] **Task 1: Update Auth Callback for Discord Metadata** (AC: 1, 2)
  - [ ] Modify `src/app/auth/callback/route.ts`
  - [ ] Extract Discord username from `user.user_metadata.user_name` or `user.user_metadata.full_name`
  - [ ] Handle both new user creation and existing user update

- [ ] **Task 2: Create User Update Logic for OAuth** (AC: 2, 3)
  - [ ] When user exists but `discordUsername` is null
  - [ ] Update with Discord username from provider metadata
  - [ ] Only update if provider is Discord

- [ ] **Task 3: Identify Provider from Auth Session** (AC: 1, 3)
  - [ ] Check `user.app_metadata.provider` to identify OAuth provider
  - [ ] Only extract Discord username when provider is 'discord'

- [ ] **Task 4: Add Provider Field to User Model** (AC: 5) [OPTIONAL]
  - [ ] Consider adding `authProvider` field to track signup method
  - [ ] Useful for conditional UI (hide Discord input for Discord OAuth users)

## Dev Notes

### Discord OAuth User Metadata
[Source: Supabase Auth + Discord OAuth docs]

When a user authenticates via Discord, Supabase stores metadata:

```typescript
// user.user_metadata (from Discord)
{
  avatar_url: "https://cdn.discordapp.com/avatars/123/abc.png",
  custom_claims: { global_name: "Display Name" },
  email: "user@example.com",
  email_verified: true,
  full_name: "username",      // Discord username (legacy)
  user_name: "username",      // Discord username (preferred)
  iss: "https://discord.com/api",
  name: "Display Name",
  picture: "https://cdn.discordapp.com/...",
  provider_id: "123456789",
  sub: "123456789"
}

// user.app_metadata
{
  provider: "discord",
  providers: ["discord"]
}
```

### Current Callback Implementation
[Source: `src/app/auth/callback/route.ts` lines 25-45]

```typescript
if (!existingUser) {
  // NEW USER - Create in public.users
  await prisma.user.create({
    data: {
      id: data.user.id,
      email: data.user.email!,
      discordUsername: data.user.user_metadata?.discordUsername || null,
    },
  })
}
```

**Problem**: Uses `discordUsername` key which is for manual signup. Discord OAuth uses `user_name` or `full_name`.

### Updated Callback Logic

```typescript
// Extract Discord username based on provider
function extractDiscordUsername(user: User): string | null {
  const provider = user.app_metadata?.provider
  
  if (provider === 'discord') {
    // Discord OAuth: username is in user_name or full_name
    return user.user_metadata?.user_name 
        || user.user_metadata?.full_name 
        || null
  }
  
  // Manual signup: discordUsername was passed in metadata
  return user.user_metadata?.discordUsername || null
}

// In callback route:
const discordUsername = extractDiscordUsername(data.user)

if (!existingUser) {
  await prisma.user.create({
    data: {
      id: data.user.id,
      email: data.user.email!,
      discordUsername,
    },
  })
} else if (!existingUser.discordUsername && discordUsername) {
  // Update existing user with Discord username
  await prisma.user.update({
    where: { id: data.user.id },
    data: { discordUsername },
  })
}
```

### Prisma User Model
[Source: `prisma/schema.prisma` lines 10-26]

```prisma
model User {
  id              String  @id @db.Uuid
  email           String  @unique
  discordUsername String?  // ✅ Already exists
  // ...
}
```

No schema changes needed - `discordUsername` field already exists.

### Testing

- **Test scenarios**:
  1. New user signs up via Discord → `discordUsername` populated
  2. Existing user (email signup) links Discord → `discordUsername` updated
  3. User signs up via Google → `discordUsername` remains null
  4. Discord username visible in admin panel

- **Manual verification**:
  ```sql
  SELECT id, email, "discordUsername" 
  FROM users 
  WHERE "discordUsername" IS NOT NULL;
  ```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial draft | SM Agent |


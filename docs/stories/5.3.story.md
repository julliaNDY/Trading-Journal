# Story 5.3: Risk Analysis - R-Multiple & Portfolio Risk

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** risk analysis including R-Multiple and portfolio risk metrics,  
**so that** I can understand my risk profile and manage risk better.

---

## Acceptance Criteria

1. **AC1**: Service Risk Analysis créé dans `src/services/analytics/risk-analysis-service.ts`.
2. **AC2**: Calcul R-Multiple par trade (basé sur stopLossPriceInitial).
3. **AC3**: Calcul risque par trade (riskUsd = abs(entry - stopLoss) * quantity).
4. **AC4**: Calcul volatilité portefeuille (standard deviation PnL).
5. **AC5**: UI affiche analyse risque (graphique + métriques).
6. **AC6**: Visualisation distribution R-Multiples (histogramme).

---

## Tasks / Subtasks

- [ ] **Task 1: Risk Analysis Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/analytics/risk-analysis-service.ts`
  - [ ] 1.2 Service analyse risque (calcul R-Multiple, volatilité)
  - [ ] 1.3 Calcul risque par trade (basé sur stopLoss)
  - [ ] 1.4 Calcul volatilité portefeuille (standard deviation PnL)

- [ ] **Task 2: R-Multiple Calculation** (AC: 2)
  - [ ] 2.1 Calcul R-Multiple par trade (basé sur stopLossPriceInitial)
  - [ ] 2.2 R-Multiple = realizedPnlUsd / riskUsd (déjà calculé partiellement)
  - [ ] 2.3 Vérifier calcul R-Multiple (Trade.riskRewardRatio existe)
  - [ ] 2.4 Stocker R-Multiple (Trade.realizedRMultiple ou Trade.riskRewardRatio)

- [ ] **Task 3: Risk Per Trade** (AC: 3)
  - [ ] 3.1 Calcul risque par trade (riskUsd = abs(entry - stopLoss) * quantity)
  - [ ] 3.2 Stocker risque en DB (Trade.riskUsd)
  - [ ] 3.3 Migration Prisma si nécessaire
  - [ ] 3.4 Calcul après chaque trade (background job)

- [ ] **Task 4: Portfolio Volatility** (AC: 4)
  - [ ] 4.1 Calcul volatilité portefeuille (standard deviation PnL)
  - [ ] 4.2 Calcul sur période (7 jours, 30 jours, all time)
  - [ ] 4.3 Stocker volatilité en DB (table `PortfolioRisk` ou calcul à la volée)
  - [ ] 4.4 Background calculation (daily job)

- [ ] **Task 5: Risk Analysis UI** (AC: 5)
  - [ ] 5.1 Composant RiskAnalysis dans `src/components/analytics/risk-analysis.tsx`
  - [ ] 5.2 Afficher métriques (R-Multiple moyen, risque total, volatilité)
  - [ ] 5.3 Graphique risque (timeline risk)
  - [ ] 5.4 Page `/risk-analysis` ou section analytics

- [ ] **Task 6: R-Multiple Distribution** (AC: 6)
  - [ ] 6.1 Histogramme distribution R-Multiples (Recharts)
  - [ ] 6.2 Visualisation distribution (bins R-Multiple)
  - [ ] 6.3 Stats : R-Multiple moyen, médian, distribution
  - [ ] 6.4 Tableau trades avec R-Multiples

---

## Dev Notes

- Dépendance : Epic 3 (Données collectées).
- R-Multiple partiellement calculé (Trade.riskRewardRatio existe), vérifier code existant.
- Performance : pré-calcul en background pour éviter latence.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 5 (Risk Analysis).

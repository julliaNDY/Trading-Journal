# Story 11.3: Email Notifications on Admin Actions

## Status

**Draft**

---

## Story

**As a** user,  
**I want** to receive email notifications when admin modifies my subscription,  
**so that** I'm informed of changes to my account.

---

## Acceptance Criteria

1. **AC1**: Email envoyé automatiquement quand admin étend/modifie/suspend abonnement.
2. **AC2**: Email inclut champ commentaire admin personnalisé.
3. **AC3**: Template email inclut : action effectuée, détails nouveau plan, commentaire admin, contact support.
4. **AC4**: Email envoyé via Resend/SendGrid API.
5. **AC5**: Livraison email trackée (succès/échec logué).

---

## Tasks / Subtasks

- [ ] **Task 1: Email Template** (AC: 3)
  - [ ] 1.1 Créer template `src/emails/admin-subscription-change.tsx`
  - [ ] 1.2 Template inclut : action, nouveau plan, commentaire admin, support contact
  - [ ] 1.3 Format HTML responsive (mobile-friendly)
  - [ ] 1.4 Support i18n (FR/EN/ES/PT)

- [ ] **Task 2: Email Sending** (AC: 1, 4)
  - [ ] 2.1 Server action `sendSubscriptionChangeEmail(userId, action, comment)`
  - [ ] 2.2 Intégrer Resend API `emails.send` (ou SendGrid)
  - [ ] 2.3 Envoyer email après modification Stripe réussie
  - [ ] 2.4 Gérer erreurs email (retry si nécessaire)

- [ ] **Task 3: Admin Comment Field** (AC: 2)
  - [ ] 3.1 Ajouter champ commentaire dans dialogs extend/modify/suspend
  - [ ] 3.2 Textarea commentaire (optionnel)
  - [ ] 3.3 Passer commentaire à action email
  - [ ] 3.4 UI shadcn/ui Textarea

- [ ] **Task 4: Email Delivery Tracking** (AC: 5)
  - [ ] 4.1 Table `EmailLog` (id, userId, type, status, sentAt, error)
  - [ ] 4.2 Logger succès/échec livraison email
  - [ ] 4.3 Retry email si échec temporaire
  - [ ] 4.4 Dashboard admin affiche statut emails envoyés

---

## Dev Notes

- Dépendance : Phase 1 (Foundation), Resend/SendGrid API.
- ⚠️ **NOTIFICATION PM** : Resend/SendGrid API requise (déjà intégré partiellement).
- Template email doit être responsive et accessible.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 10 (Email Notifications).

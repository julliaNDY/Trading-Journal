# Story 3.7: Import Profiles - CSV Mapping Configurations

## Status

**Completed** ✅

---

## Story

**As a** trader,  
**I want** to save and reuse CSV column mappings for different brokers,  
**so that** I can quickly import trades without re-configuring mappings each time.

---

## Acceptance Criteria

1. **AC1**: Table `ImportProfile` permet stockage mappings réutilisables (existe déjà, vérifier).
2. **AC2**: UI création profil d'import avec mapping colonnes.
3. **AC3**: Sélection profil existant lors import CSV.
4. **AC4**: Actions CRUD sur profils d'import (créer, modifier, supprimer).
5. **AC5**: Profils par défaut pour brokers populaires (Tradovate, IBKR, etc.).
6. **AC6**: Auto-détection format broker lors upload CSV.

---

## Tasks / Subtasks

- [x] **Task 1: Import Profile Schema** (AC: 1)
  - [x] 1.1 Vérifier table `ImportProfile` existe (Prisma schema)
  - [x] 1.2 Champs : userId, name, brokerName, columnMapping (JSON), createdAt
  - [x] 1.3 Migration Prisma si nécessaire
  - [x] 1.4 Unique constraint (userId + name)

- [x] **Task 2: Profile Creation UI** (AC: 2)
  - [x] 2.1 Dialog création profil dans page import
  - [x] 2.2 Formulaire : name, broker (select), column mapping (dynamic form)
  - [x] 2.3 Column mapping : source column → target field (dropdown pour chaque)
  - [x] 2.4 Preview mapping (afficher colonnes détectées)

- [x] **Task 3: Profile Selection** (AC: 3)
  - [x] 3.1 Dropdown sélection profil lors import CSV
  - [x] 3.2 Auto-remplir mapping si profil sélectionné
  - [x] 3.3 Option "Create New Profile" dans dropdown
  - [x] 3.4 Mémoriser dernier profil utilisé (localStorage)

- [x] **Task 4: CRUD Actions** (AC: 4)
  - [x] 4.1 Page `/import/profiles` (optionnel) ou section dans page import
  - [x] 4.2 Action `createImportProfile(data)`
  - [x] 4.3 Action `updateImportProfile(id, data)`
  - [x] 4.4 Action `deleteImportProfile(id)` avec confirmation
  - [x] 4.5 Liste profils existants

- [x] **Task 5: Default Profiles** (AC: 5)
  - [x] 5.1 Seed DB avec profils par défaut (Tradovate, IBKR, MetaTrader, etc.)
  - [x] 5.2 Script seed : `prisma/seed-import-profiles.ts`
  - [x] 5.3 Profils système (non modifiables, non supprimables)
  - [x] 5.4 Champ `isSystem: boolean` pour profils par défaut

- [x] **Task 6: Auto-Detection** (AC: 6)
  - [x] 6.1 Service `detectBrokerFormat(csvHeaders)` dans `src/services/broker-detection-service.ts`
  - [x] 6.2 Patterns détection (colonnes caractéristiques par broker)
  - [x] 6.3 Suggestion profil basée sur détection
  - [x] 6.4 Message utilisateur : "Format détecté : Tradovate"

---

## Dev Notes

- Table `ImportProfile` existe déjà (vérifier Prisma schema).
- Patterns détection : colonnes clés (ex: "Trade ID" pour certains brokers).
- Profils par défaut : Tradovate, IBKR, MetaTrader4, MetaTrader5, NinjaTrader, etc.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Import profiles).
- Référencer code existant dans `src/app/(dashboard)/import/`.

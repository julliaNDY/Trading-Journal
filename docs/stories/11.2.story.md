# Story 11.2: Extend/Modify/Suspend Subscriptions

## Status

**Draft**

---

## Story

**As an** admin,  
**I want** to extend, modify, or suspend user subscriptions,  
**so that** I can manage customer accounts and support requests.

---

## Acceptance Criteria

1. **AC1**: Admin peut étendre abonnement (ajouter jours/mois à période actuelle).
2. **AC2**: Admin peut modifier abonnement (changer plan, interval).
3. **AC3**: Admin peut suspendre abonnement (pause, annulation immédiate).
4. **AC4**: Toutes actions utilisent Stripe API `subscriptions.update`.
5. **AC5**: Changements reflétés immédiatement dans Stripe et DB locale.

---

## Tasks / Subtasks

- [ ] **Task 1: Extend Subscription** (AC: 1)
  - [ ] 1.1 UI bouton/action "Extend" sur user admin
  - [ ] 1.2 Dialog input (nombre jours/mois à ajouter)
  - [ ] 1.3 Server action `extendSubscription(userId, days)`
  - [ ] 1.4 Stripe API `subscriptions.update` avec `current_period_end`

- [ ] **Task 2: Modify Subscription** (AC: 2)
  - [ ] 2.1 UI bouton/action "Modify" sur user admin
  - [ ] 2.2 Dialog select (nouveau plan, nouvel interval)
  - [ ] 2.3 Server action `modifySubscription(userId, planInterval)`
  - [ ] 2.4 Stripe API `subscriptions.update` avec `items` (changer price)

- [ ] **Task 3: Suspend Subscription** (AC: 3)
  - [ ] 3.1 UI bouton/action "Suspend" sur user admin
  - [ ] 3.2 AlertDialog confirmation (pause vs cancel)
  - [ ] 3.3 Server action `suspendSubscription(userId, action)`
  - [ ] 3.4 Stripe API `subscriptions.update` avec `cancel_at_period_end` ou `cancel()` immédiat

- [ ] **Task 4: Stripe API Integration** (AC: 4)
  - [ ] 4.1 Intégrer Stripe API `subscriptions.update` dans `src/services/stripe-service.ts`
  - [ ] 4.2 Gérer erreurs Stripe (rate limits, invalid params)
  - [ ] 4.3 Retry/backoff si erreur temporaire
  - [ ] 4.4 Logs Stripe API calls

- [ ] **Task 5: DB Sync** (AC: 5)
  - [ ] 5.1 Mettre à jour table Prisma `Subscription` après update Stripe
  - [ ] 5.2 Webhook Stripe comme backup (sync automatique)
  - [ ] 5.3 Validation cohérence Stripe vs DB
  - [ ] 5.4 Refresh UI après modification

---

## Dev Notes

- Dépendance : Phase 1 (Foundation), Stripe API.
- ⚠️ **NOTIFICATION PM** : Stripe API `subscriptions.update` requise (déjà intégré partiellement).
- Utiliser Stripe webhooks comme backup pour sync DB.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 10 (Admin User Management).

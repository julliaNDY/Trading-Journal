# Story 11.2: Intégration Payment Gateway (Stripe)

## Status

**Approved**

---

## Story

**As a** user wanting to subscribe to a paid plan,  
**I want** to pay securely via credit card or other payment methods,  
**so that** I can access premium features immediately after payment.

---

## Acceptance Criteria

1. **AC1**: Une interface `PaymentProvider` abstraite permet d'ajouter d'autres providers facilement
2. **AC2**: L'implémentation Stripe est fonctionnelle avec Checkout Session
3. **AC3**: Les webhooks Stripe mettent à jour automatiquement le statut des subscriptions
4. **AC4**: L'utilisateur peut accéder au Stripe Customer Portal pour gérer son abonnement
5. **AC5**: Les variables d'environnement Stripe sont documentées et sécurisées
6. **AC6**: Le mode test Stripe fonctionne en développement
7. **AC7**: Les erreurs de paiement sont gérées gracieusement avec messages i18n
8. **AC8**: Tests unitaires pour le payment service (≥80% coverage)

---

## Tasks / Subtasks

- [ ] **Task 1: Installer les dépendances Stripe** (AC: 2, 6)
  - [ ] 1.1 `npm install stripe @stripe/stripe-js`
  - [ ] 1.2 Configurer les variables d'environnement (STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET)
  - [ ] 1.3 Documenter dans env.example

- [ ] **Task 2: Créer l'abstraction PaymentProvider** (AC: 1)
  - [ ] 2.1 Créer `src/types/payment.ts` avec l'interface PaymentProvider
  - [ ] 2.2 Définir les méthodes : `createCheckoutSession`, `createCustomerPortalSession`, `handleWebhook`, `getCustomer`
  - [ ] 2.3 Définir les types : `CheckoutSessionInput`, `WebhookEvent`, `CustomerData`

- [ ] **Task 3: Implémenter StripeProvider** (AC: 2, 6)
  - [ ] 3.1 Créer `src/services/payment/stripe-provider.ts`
  - [ ] 3.2 Implémenter `createCheckoutSession()` - redirige vers Stripe Checkout
  - [ ] 3.3 Implémenter `createCustomerPortalSession()` - gestion abonnement côté Stripe
  - [ ] 3.4 Implémenter `handleWebhook()` - parse et valide les webhooks
  - [ ] 3.5 Implémenter `syncCustomer()` - crée/récupère le customer Stripe

- [ ] **Task 4: Créer le Payment Service centralisé** (AC: 1, 2)
  - [ ] 4.1 Créer `src/services/payment-service.ts`
  - [ ] 4.2 Factory pattern pour sélectionner le provider (Stripe par défaut)
  - [ ] 4.3 Méthodes : `initiateCheckout()`, `openCustomerPortal()`, `processWebhook()`

- [ ] **Task 5: Ajouter stripeCustomerId au modèle User** (AC: 2)
  - [ ] 5.1 Modifier `prisma/schema.prisma` - ajouter `stripeCustomerId String? @unique`
  - [ ] 5.2 Créer migration `add_stripe_customer_id`
  - [ ] 5.3 Mettre à jour les types subscription

- [ ] **Task 6: Créer l'API route webhooks** (AC: 3)
  - [ ] 6.1 Créer `src/app/api/webhooks/stripe/route.ts`
  - [ ] 6.2 Valider la signature Stripe
  - [ ] 6.3 Gérer les events : `checkout.session.completed`, `invoice.paid`, `invoice.payment_failed`, `customer.subscription.updated`, `customer.subscription.deleted`
  - [ ] 6.4 Mettre à jour Subscription/Invoice/Payment en DB

- [ ] **Task 7: Créer les server actions payment** (AC: 2, 4)
  - [ ] 7.1 Créer `src/app/actions/payment.ts`
  - [ ] 7.2 `createCheckoutSession(planId)` - retourne URL Stripe Checkout
  - [ ] 7.3 `createPortalSession()` - retourne URL Customer Portal
  - [ ] 7.4 `getPaymentStatus()` - vérifie le statut du paiement en cours

- [ ] **Task 8: Créer les pages success/cancel** (AC: 7)
  - [ ] 8.1 Créer `src/app/(dashboard)/subscription/success/page.tsx`
  - [ ] 8.2 Créer `src/app/(dashboard)/subscription/cancel/page.tsx`
  - [ ] 8.3 Ajouter messages i18n (fr.json, en.json)

- [ ] **Task 9: Tests unitaires** (AC: 8)
  - [ ] 9.1 Créer `src/services/payment/__tests__/stripe-provider.test.ts`
  - [ ] 9.2 Tester `createCheckoutSession()` avec mocks
  - [ ] 9.3 Tester `handleWebhook()` avec différents event types
  - [ ] 9.4 Tester la validation de signature
  - [ ] 9.5 Vérifier coverage ≥80%

---

## Dev Notes

### Contexte Technique

**Dépendances de la Story 11.1 :**
- Modèles Prisma : `Plan`, `Subscription`, `Invoice`, `Payment`
- Service : `subscription-service.ts` avec `createSubscription()`, `recordPayment()`, `createInvoice()`
- Types : `src/types/subscription.ts`

**Stack Stripe :**
- `stripe` (Node.js SDK) - pour les opérations serveur
- `@stripe/stripe-js` (Browser SDK) - pour le redirect Checkout

### Architecture Payment Provider

```typescript
// src/types/payment.ts

export interface PaymentProvider {
  readonly name: string;
  
  // Checkout
  createCheckoutSession(input: CheckoutSessionInput): Promise<CheckoutSessionResult>;
  
  // Customer Portal
  createCustomerPortalSession(customerId: string, returnUrl: string): Promise<string>;
  
  // Webhooks
  handleWebhook(payload: string, signature: string): Promise<WebhookResult>;
  
  // Customer
  getOrCreateCustomer(userId: string, email: string): Promise<string>;
}

export interface CheckoutSessionInput {
  userId: string;
  email: string;
  planId: string;
  planName: string;
  priceAmount: number; // in cents
  interval: 'month' | 'quarter' | 'year';
  successUrl: string;
  cancelUrl: string;
}

export interface CheckoutSessionResult {
  sessionId: string;
  url: string;
}

export interface WebhookResult {
  eventType: string;
  handled: boolean;
  subscriptionId?: string;
  error?: string;
}
```

### Stripe Checkout Flow

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   User clicks   │────▶│ createCheckout   │────▶│ Stripe Checkout │
│   "Subscribe"   │     │ Session (server) │     │    (hosted)     │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼ Payment
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Subscription   │◀────│ Webhook handler  │◀────│ Stripe Webhook  │
│  activated      │     │ (update DB)      │     │  (async)        │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

### Variables d'environnement

```bash
# Stripe API Keys
STRIPE_SECRET_KEY=sk_test_...          # Server-side only
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...  # Client-side OK
STRIPE_WEBHOOK_SECRET=whsec_...        # For webhook signature verification

# URLs for redirects
APP_URL=https://tradingpathjournal.com  # Already exists
```

### Stripe Products & Prices

Les plans doivent être créés dans Stripe Dashboard avec les Price IDs correspondants.
On stockera le `stripePriceId` dans notre table `Plan` (à ajouter au schéma).

```prisma
model Plan {
  // ... existing fields
  stripePriceId String? @unique  // Stripe Price ID (price_xxx)
}
```

### Webhook Events à gérer

| Event | Action |
|-------|--------|
| `checkout.session.completed` | Créer Subscription + Invoice + Payment en DB |
| `invoice.paid` | Marquer Invoice comme payée, renouveler Subscription |
| `invoice.payment_failed` | Marquer Subscription comme PAST_DUE |
| `customer.subscription.updated` | Sync status (upgrade/downgrade) |
| `customer.subscription.deleted` | Marquer Subscription comme CANCELED |

### Structure des fichiers

```
src/
├── types/
│   └── payment.ts              # Interface PaymentProvider + types
├── services/
│   ├── payment/
│   │   ├── index.ts            # Export factory
│   │   ├── stripe-provider.ts  # Implémentation Stripe
│   │   └── __tests__/
│   │       └── stripe-provider.test.ts
│   └── payment-service.ts      # Service centralisé
├── app/
│   ├── api/
│   │   └── webhooks/
│   │       └── stripe/
│   │           └── route.ts    # POST handler pour webhooks
│   ├── actions/
│   │   └── payment.ts          # Server actions
│   └── (dashboard)/
│       └── subscription/
│           ├── success/
│           │   └── page.tsx
│           └── cancel/
│               └── page.tsx
└── lib/
    └── stripe.ts               # Stripe client singleton
```

### Modification Schema Prisma

```prisma
model User {
  // ... existing fields
  stripeCustomerId String? @unique
}

model Plan {
  // ... existing fields
  stripePriceId String? @unique
}
```

### Traductions i18n

```json
// messages/fr.json
{
  "subscription": {
    "checkout": {
      "loading": "Redirection vers le paiement...",
      "error": "Erreur lors de la création de la session de paiement"
    },
    "success": {
      "title": "Paiement réussi !",
      "description": "Votre abonnement est maintenant actif.",
      "cta": "Accéder au dashboard"
    },
    "cancel": {
      "title": "Paiement annulé",
      "description": "Vous n'avez pas été facturé.",
      "cta": "Retour aux plans"
    },
    "portal": {
      "manage": "Gérer mon abonnement",
      "loading": "Ouverture du portail..."
    }
  }
}
```

---

## Testing

### Test File Location
`src/services/payment/__tests__/stripe-provider.test.ts`

### Testing Standards
- Framework: Vitest
- Mocking: `vi.mock('stripe')` pour le SDK Stripe
- Coverage minimum: 80%

### Key Test Scenarios

```typescript
describe('StripeProvider', () => {
  describe('createCheckoutSession', () => {
    it('should create session with correct parameters', async () => {})
    it('should include customer ID if exists', async () => {})
    it('should create new customer if not exists', async () => {})
    it('should throw on Stripe API error', async () => {})
  })
  
  describe('handleWebhook', () => {
    it('should validate signature correctly', async () => {})
    it('should reject invalid signature', async () => {})
    it('should handle checkout.session.completed', async () => {})
    it('should handle invoice.paid', async () => {})
    it('should handle invoice.payment_failed', async () => {})
    it('should handle customer.subscription.deleted', async () => {})
    it('should ignore unknown event types', async () => {})
  })
  
  describe('createCustomerPortalSession', () => {
    it('should return portal URL', async () => {})
    it('should throw if customer not found', async () => {})
  })
})
```

### Stripe Test Mode

En développement, utiliser les clés de test Stripe :
- Carte test : `4242 4242 4242 4242`
- Date : n'importe quelle date future
- CVC : n'importe quels 3 chiffres

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 1.0 | Story draft créée | SM Bob |

---

## Dev Agent Record

### Agent Model Used
_À remplir par le Dev Agent_

### Debug Log References
_À remplir par le Dev Agent_

### Completion Notes List
_À remplir par le Dev Agent_

### File List
_À remplir par le Dev Agent_

---

## QA Results
_À remplir par le QA Agent_


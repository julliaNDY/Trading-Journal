# Story 8.1: Configuration Supabase Auth Providers

## Status

Draft

## Story

**As a** product owner,
**I want** Google, Apple, and Discord OAuth providers configured in Supabase,
**so that** users can sign up and log in using their existing social accounts.

## Acceptance Criteria

1. Google OAuth provider is enabled and configured in Supabase Dashboard
2. Apple OAuth provider is enabled and configured in Supabase Dashboard  
3. Discord OAuth provider is enabled and configured in Supabase Dashboard
4. All redirect URLs are properly configured for both development and production
5. OAuth credentials are securely stored in Supabase (not in codebase)
6. Auth callback route handles OAuth flow correctly for all providers

## Tasks / Subtasks

- [ ] **Task 1: Google OAuth Setup** (AC: 1, 4, 5)
  - [ ] Create Google Cloud Console project (if not exists)
  - [ ] Enable Google+ API
  - [ ] Create OAuth 2.0 credentials (Web application type)
  - [ ] Configure authorized redirect URIs:
    - `https://ioqqiyluatbcckuuprcc.supabase.co/auth/v1/callback`
  - [ ] Add Client ID and Client Secret in Supabase Dashboard > Authentication > Providers > Google

- [ ] **Task 2: Apple OAuth Setup** (AC: 2, 4, 5)
  - [ ] Create Apple Developer account (if not exists)
  - [ ] Register App ID with Sign In with Apple capability
  - [ ] Create Services ID for web authentication
  - [ ] Create and download private key (.p8)
  - [ ] Configure redirect URI: `https://ioqqiyluatbcckuuprcc.supabase.co/auth/v1/callback`
  - [ ] Add Service ID, Team ID, Key ID, and Private Key in Supabase Dashboard > Authentication > Providers > Apple

- [ ] **Task 3: Discord OAuth Setup** (AC: 3, 4, 5)
  - [ ] Create Discord Application in Discord Developer Portal
  - [ ] Enable OAuth2 in application settings
  - [ ] Add redirect URI: `https://ioqqiyluatbcckuuprcc.supabase.co/auth/v1/callback`
  - [ ] Configure scopes: `identify`, `email`
  - [ ] Add Client ID and Client Secret in Supabase Dashboard > Authentication > Providers > Discord

- [ ] **Task 4: Update Auth Callback** (AC: 6)
  - [ ] Verify `src/app/auth/callback/route.ts` handles OAuth users correctly
  - [ ] Ensure user is created in `public.users` table on first OAuth login
  - [ ] Handle provider-specific metadata (Discord username, etc.)

- [ ] **Task 5: Configure Supabase Auth Settings** (AC: 4)
  - [ ] Add Site URL: `https://tradingpathjournal.com`
  - [ ] Add Additional Redirect URLs:
    - `http://localhost:3000/auth/callback`
    - `https://tradingpathjournal.com/auth/callback`

## Dev Notes

### Supabase Project Info
[Source: Memory - Supabase credentials]
- Project ID: `ioqqiyluatbcckuuprcc`
- Production domain: `tradingpathjournal.com`
- Supabase Auth Callback URL: `https://ioqqiyluatbcckuuprcc.supabase.co/auth/v1/callback`

### Current Auth Callback Implementation
[Source: `src/app/auth/callback/route.ts`]

The existing callback route already:
1. Exchanges code for session via `supabase.auth.exchangeCodeForSession(code)`
2. Creates user in `public.users` if not exists
3. Extracts `discordUsername` from `user_metadata`

```typescript
// Existing user creation logic (line 33-45)
await prisma.user.create({
  data: {
    id: data.user.id,
    email: data.user.email!,
    discordUsername: data.user.user_metadata?.discordUsername || null,
  },
})
```

**Modification needed**: Update to extract Discord username from provider metadata when using Discord OAuth.

### OAuth Provider Metadata Structure

**Google:**
```typescript
user.user_metadata = {
  full_name: "John Doe",
  email: "john@gmail.com",
  avatar_url: "https://...",
  provider_id: "123456789"
}
```

**Apple:**
```typescript
user.user_metadata = {
  email: "john@privaterelay.appleid.com", // May be relay email
  full_name: "John Doe" // Only on first auth
}
```

**Discord:**
```typescript
user.user_metadata = {
  full_name: "john_doe",
  user_name: "john_doe", // This is the Discord username
  email: "john@example.com",
  avatar_url: "https://cdn.discordapp.com/...",
  provider_id: "123456789"
}
```

### Prisma User Model
[Source: `prisma/schema.prisma` lines 10-26]

```prisma
model User {
  id              String  @id @db.Uuid  // Matches Supabase auth.users.id
  email           String  @unique
  discordUsername String?  // Already exists for Discord integration
  // ... other fields
}
```

### Testing

- **Test file location**: Not applicable (dashboard configuration)
- **Manual testing checklist**:
  1. Test Google login on localhost
  2. Test Apple login on localhost (requires HTTPS, may need ngrok)
  3. Test Discord login on localhost
  4. Verify user created in `public.users` table
  5. Test on production domain

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 1.0 | Initial draft | SM Agent |


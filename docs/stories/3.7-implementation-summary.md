# Story 3.7 - Import Profiles Implementation Summary

## Status: ✅ Completed

---

## Overview

Story 3.7 implements a comprehensive import profile system that allows users to save and reuse CSV column mappings for different brokers. The system includes automatic broker detection, system profiles for popular brokers, and full CRUD operations for custom user profiles.

---

## Features Implemented

### 1. Database Schema
- **ImportProfile Model** with fields:
  - `id`, `userId`, `name`
  - `brokerName` (nullable) - Broker identifier
  - `mapping` (JSON) - CsvMapping configuration
  - `isSystem` (boolean) - System profiles cannot be deleted/modified
  - Unique constraint on `(userId, name)`
  - Index on `brokerName`

### 2. Broker Detection Service
- **14 Broker Patterns** supported:
  - **Futures/Stocks**: Tradovate, IBKR, NinjaTrader, TradeStation, Thinkorswim, E*TRADE, Robinhood, Webull
  - **Forex**: MetaTrader 4, MetaTrader 5
  - **Crypto**: Binance, Coinbase, Kraken, Bybit
  - **Fallback**: Generic format

- **Detection Algorithm**:
  - Score-based matching (required columns: 10 pts, optional: 2 pts)
  - Normalized column names (case-insensitive, spaces/dashes normalized)
  - Minimum score of 10 for valid match
  - Auto-suggests matching profile when CSV is uploaded

### 3. CRUD Operations
- **Server Actions** (`src/app/actions/import-profiles.ts`):
  - `getImportProfiles()` - Get all profiles (user + system)
  - `getImportProfile(id)` - Get single profile
  - `createImportProfile(name, brokerName, mapping)` - Create new profile
  - `updateImportProfile(id, name, brokerName, mapping)` - Update profile
  - `deleteImportProfile(id)` - Delete profile
  - `getImportProfilesByBroker(brokerName)` - Filter by broker

### 4. UI Components

#### ImportProfileDialog
- Create/edit profile dialog
- Broker selection dropdown
- Column mapping interface with dropdowns for each field
- Required fields validation
- CSV headers auto-populated in dropdowns

#### ImportProfileSelector
- Profile selection dropdown
- System profiles section (non-editable)
- User profiles section (editable)
- Edit/Delete buttons for user profiles
- Auto-detection banner when broker is detected
- Profile info display with broker badge

### 5. Integration with Import Workflow
- Profile selector added to import preview step
- Auto-detection runs on CSV upload
- Selected profile mapping used for import
- Last used profile saved to localStorage
- Seamless integration with existing import flow

### 6. Internationalization
- **English** (`messages/en.json`): 40+ translations
- **French** (`messages/fr.json`): 40+ translations
- All UI text properly translated

---

## File Structure

```
prisma/
├── schema.prisma (ImportProfile model updated)
├── migrations/20260117200000_add_import_profile_fields/
│   └── migration.sql
└── seed-import-profiles.ts (seed script for system profiles)

src/
├── app/
│   ├── actions/
│   │   └── import-profiles.ts (CRUD actions)
│   └── (dashboard)/
│       └── importer/
│           └── import-content.tsx (integration)
├── components/
│   └── import/
│       ├── import-profile-dialog.tsx
│       ├── import-profile-selector.tsx
│       └── index.ts (exports)
└── services/
    ├── broker-detection-service.ts (14 broker patterns)
    └── import-service.ts (validateMapping added)

messages/
├── en.json (import.profiles section)
└── fr.json (import.profiles section)
```

---

## Usage Instructions

### For Users

1. **Upload CSV**:
   - Drag & drop or select CSV file
   - System automatically detects broker format
   - Matching profile is suggested

2. **Select Profile**:
   - Choose from system profiles (Tradovate, IBKR, etc.)
   - Or select your custom profile
   - Or create new profile

3. **Create Custom Profile**:
   - Click "Create new profile" in dropdown
   - Name your profile
   - Select broker (optional)
   - Map CSV columns to trade fields
   - Save for reuse

4. **Edit/Delete Profile**:
   - Select your custom profile
   - Click Edit icon to modify
   - Click Delete icon to remove
   - System profiles cannot be edited/deleted

### For Developers

#### Seed System Profiles
```bash
npx tsx prisma/seed-import-profiles.ts
```

#### Run Migration
```bash
npx prisma migrate deploy
```

#### Add New Broker Pattern
Edit `src/services/broker-detection-service.ts`:
```typescript
{
  brokerName: 'newbroker',
  displayName: 'New Broker',
  requiredColumns: ['symbol', 'qty', 'price', 'pnl'],
  optionalColumns: ['time', 'side'],
  mapping: {
    symbol: 'Symbol',
    date: 'Time',
    // ... other mappings
  },
}
```

---

## Testing Checklist

- [ ] Upload CSV with known broker format (e.g., Tradovate)
- [ ] Verify broker auto-detection banner appears
- [ ] Verify matching system profile is suggested
- [ ] Create custom profile with CSV headers
- [ ] Edit custom profile
- [ ] Delete custom profile
- [ ] Verify system profiles cannot be edited/deleted
- [ ] Import trades using system profile
- [ ] Import trades using custom profile
- [ ] Verify last used profile is remembered (localStorage)
- [ ] Test with multiple brokers
- [ ] Test i18n (EN/FR)

---

## API Reference

### ImportProfile Type
```typescript
interface ImportProfile {
  id: string;
  userId: string;
  name: string;
  brokerName: string | null;
  mapping: CsvMapping;
  isSystem: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

### CsvMapping Type
```typescript
interface CsvMapping {
  symbol: string;
  date?: string;
  openedAt?: string;
  closedAt?: string;
  direction?: string;
  entryPrice: string;
  exitPrice: string;
  quantity: string;
  realizedPnlUsd: string;
  floatingRunupUsd?: string;
  floatingDrawdownUsd?: string;
}
```

### BrokerPattern Type
```typescript
interface BrokerPattern {
  brokerName: string;
  displayName: string;
  requiredColumns: string[];
  optionalColumns?: string[];
  mapping: CsvMapping;
}
```

---

## Known Limitations

1. **System User**: System profiles use a fixed UUID (`00000000-0000-0000-0000-000000000000`)
2. **Generic Pattern**: Excluded from auto-detection to avoid false positives
3. **Column Matching**: Uses fuzzy matching (contains) which may have edge cases
4. **Profile Limit**: No hard limit on number of custom profiles per user

---

## Future Enhancements

1. **Profile Sharing**: Allow users to share custom profiles
2. **Profile Templates**: More pre-built templates for niche brokers
3. **Smart Mapping**: ML-based column mapping suggestions
4. **Validation Preview**: Show sample data with applied mapping before import
5. **Profile Analytics**: Track which profiles are most used
6. **Bulk Operations**: Import/export profiles as JSON

---

## Related Stories

- **Story 3.6**: Broker Connections UI (completed)
- **Story 3.8**: Broker List - 240+ Supported Brokers Database (next)
- **Story 3.1-3.5**: Multi-Account & Broker Sync features

---

## Acceptance Criteria Status

| AC | Description | Status |
|----|-------------|--------|
| AC1 | Table ImportProfile permet stockage mappings réutilisables | ✅ |
| AC2 | UI création profil d'import avec mapping colonnes | ✅ |
| AC3 | Sélection profil existant lors import CSV | ✅ |
| AC4 | Actions CRUD sur profils d'import | ✅ |
| AC5 | Profils par défaut pour brokers populaires | ✅ |
| AC6 | Auto-détection format broker lors upload CSV | ✅ |

---

## Conclusion

Story 3.7 is fully implemented and ready for testing. The system provides a robust, user-friendly way to manage CSV import configurations with intelligent broker detection and comprehensive CRUD operations.

# üöÄ Story 3.8 - QUICK START GUIDE
## 240+ Broker Database - Implementation Checklist

> **Date** : 2026-01-17  
> **Status** : Ready to Implement  
> **Estimated Duration** : 3-4 days for full completion  
> **Owner** : Dev Team

---

## üìä Current Status

| Task | Status | Completion |
|------|--------|------------|
| Broker Compilation (250+) | ‚úÖ Done | 100% |
| Prisma Schema | ‚ùå Not Started | 0% |
| Seed Script | ‚ùå Not Started | 0% |
| API Endpoint | ‚ùå Not Started | 0% |
| Admin CRUD UI | ‚ùå Not Started | 0% |
| **Overall Story 3.8** | üü° In Progress | **30%** |

---

## üéØ Implementation Tasks (Sprint Order)

### Task 1: Prisma Schema + Migration (1 day)
**Assigned to**: Backend Dev  
**ETA**: 1 day  
**Difficulty**: Easy  

#### 1.1 Update Prisma Schema
File: `prisma/schema.prisma`

**Add these enums:**
```prisma
enum BrokerType {
  FOREX
  FUTURES
  STOCKS
  CRYPTO
  MULTI_ASSET
  PROP_FIRM
}

enum IntegrationStatus {
  API              // Full API integration available
  FILE_UPLOAD      // CSV/Excel upload only
  COMING_SOON      // Planned future support
}
```

**Add Broker model:**
```prisma
model Broker {
  id                  String      @id @default(cuid())
  name                String      @unique
  country             String      // e.g., "USA", "UK", "EU"
  type                BrokerType
  integrationStatus   IntegrationStatus
  
  logoUrl             String?     // URL to broker logo
  websiteUrl          String?     // Official website
  documentationUrl    String?     // API documentation URL
  supportedAssets     String[]    @default([]) // ["FOREX", "FUTURES", "STOCKS", "CRYPTO", "OPTIONS"]
  
  apiDocumentationUrl String?     // If integrationStatus = API
  csvTemplateUrl      String?     // If integrationStatus = FILE_UPLOAD
  
  notes               String?     // Internal notes
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}
```

#### 1.2 Create Migration
```bash
cd /Users/l3j/Desktop/Trading/Useful\ Shit/Trading-Journal/cryptosite
npx prisma migrate dev --name add_broker_table
```

**Expected output:**
```
‚úì Generated migration file
‚úì Ran 1 migration
‚úì Database synced
```

#### 1.3 Verify Schema
```bash
npx prisma studio
# Navigate to Broker model in Prisma Studio UI
```

---

### Task 2: Seed Script + Data Population (1 day)
**Assigned to**: Backend Dev  
**ETA**: 1 day  
**Difficulty**: Medium  

#### 2.1 Convert Broker Compilation ‚Üí TypeScript
File: `prisma/seed-brokers.ts`

**Source Data**: `docs/stories/3.8-broker-compilation.md`

**Template:**
```typescript
import { PrismaClient, BrokerType, IntegrationStatus } from '@prisma/client';

const prisma = new PrismaClient();

const brokers = [
  {
    name: 'Interactive Brokers',
    country: 'USA',
    type: BrokerType.MULTI_ASSET,
    integrationStatus: IntegrationStatus.API,
    logoUrl: 'https://www.interactivebrokers.com/images/web/logos/ib-logo.svg',
    websiteUrl: 'https://www.interactivebrokers.com',
    documentationUrl: 'https://www.interactivebrokers.com/en/index.php?f=45923',
    supportedAssets: ['FOREX', 'FUTURES', 'STOCKS', 'CRYPTO', 'OPTIONS'],
    notes: 'Flex Query API - Production ready',
  },
  // ... 249 more brokers from 3.8-broker-compilation.md
];

async function main() {
  console.log('üå± Seeding broker database...');
  
  for (const broker of brokers) {
    const existing = await prisma.broker.findUnique({
      where: { name: broker.name },
    });
    
    if (!existing) {
      await prisma.broker.create({
        data: broker,
      });
      console.log(`‚úì Created: ${broker.name}`);
    }
  }
  
  const totalCount = await prisma.broker.count();
  console.log(`‚úÖ Seeding complete! Total brokers: ${totalCount}`);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

#### 2.2 Execute Seed Script
```bash
npx prisma db seed
```

**Expected output:**
```
‚úì Created: Interactive Brokers
‚úì Created: Charles Schwab
...
‚úÖ Seeding complete! Total brokers: 250
```

#### 2.3 Verify Data
```bash
npx prisma studio
# or
sqlite3 prisma/dev.db "SELECT COUNT(*) FROM Broker;"
```

**Expected**: Should show ~250 brokers in database

---

### Task 3: API Endpoint - GET /api/brokers (1 day)
**Assigned to**: Backend/API Dev  
**ETA**: 1 day  
**Difficulty**: Medium  

#### 3.1 Create API Route
File: `src/app/api/brokers/route.ts`

**Implement:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { cache } from '@/lib/cache';
import { logger } from '@/lib/logger';

export async function GET(request: NextRequest) {
  try {
    // Parse query parameters
    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') ?? '1');
    const limit = parseInt(searchParams.get('limit') ?? '50');
    const search = searchParams.get('search') ?? '';
    const country = searchParams.get('country') ?? '';
    const type = searchParams.get('type') ?? '';
    const integrationStatus = searchParams.get('integrationStatus') ?? '';
    
    // Generate cache key
    const cacheKey = `brokers:page:${page}:limit:${limit}:search:${search}:country:${country}:type:${type}:status:${integrationStatus}`;
    
    // Try to get from cache
    const cached = await cache.get(cacheKey);
    if (cached) {
      return NextResponse.json(cached);
    }
    
    // Build where clause
    const where: any = {};
    if (search) where.name = { contains: search, mode: 'insensitive' };
    if (country) where.country = country;
    if (type) where.type = type;
    if (integrationStatus) where.integrationStatus = integrationStatus;
    
    // Query database
    const [brokers, total] = await Promise.all([
      prisma.broker.findMany({
        where,
        skip: (page - 1) * limit,
        take: limit,
        orderBy: { name: 'asc' },
      }),
      prisma.broker.count({ where }),
    ]);
    
    // Build response
    const response = {
      data: brokers,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit),
      },
    };
    
    // Cache response (5 minutes)
    await cache.set(cacheKey, response, 300);
    
    return NextResponse.json(response);
  } catch (error) {
    logger.error('GET /api/brokers failed', error);
    return NextResponse.json(
      { error: 'Failed to fetch brokers' },
      { status: 500 }
    );
  }
}
```

#### 3.2 Test Endpoints
```bash
# Get all brokers (paginated)
curl "http://localhost:3000/api/brokers?page=1&limit=10"

# Filter by country
curl "http://localhost:3000/api/brokers?country=USA&limit=25"

# Filter by type
curl "http://localhost:3000/api/brokers?type=FOREX"

# Filter by integration status
curl "http://localhost:3000/api/brokers?integrationStatus=API"

# Search by name
curl "http://localhost:3000/api/brokers?search=Interactive"

# Combine filters
curl "http://localhost:3000/api/brokers?country=USA&type=STOCKS&limit=50"
```

---

### Task 4: Admin CRUD Interface (1 day)
**Assigned to**: Frontend Dev + Backend Dev  
**ETA**: 1 day  
**Difficulty**: Medium-Hard  

#### 4.1 Create Admin Page
File: `src/app/(dashboard)/admin/brokers/page.tsx`

**Basic structure:**
```typescript
import { getUser } from '@/lib/auth';
import { redirect } from 'next/navigation';
import BrokersTable from '@/components/admin/brokers-table';

export default async function BrokersAdminPage() {
  const user = await getUser();
  
  if (!user?.isAdmin) {
    redirect('/');
  }
  
  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">Manage Brokers</h1>
        <AddBrokerDialog />
      </div>
      
      <BrokersTable />
    </div>
  );
}
```

#### 4.2 Create Broker Table Component
File: `src/components/admin/brokers-table.tsx`

**Features:**
- Display 250+ brokers in paginated table
- Search/filter functionality
- Edit & Delete buttons
- Add new broker button (dialog)

#### 4.3 Create Server Actions
File: `src/app/actions/brokers.ts`

```typescript
'use server';

import { prisma } from '@/lib/prisma';
import { getUser } from '@/lib/auth';
import { cache } from '@/lib/cache';

export async function createBroker(data: any) {
  const user = await getUser();
  if (!user?.isAdmin) throw new Error('Unauthorized');
  
  const broker = await prisma.broker.create({ data });
  await invalidateBrokerCache();
  return broker;
}

export async function updateBroker(id: string, data: any) {
  const user = await getUser();
  if (!user?.isAdmin) throw new Error('Unauthorized');
  
  const broker = await prisma.broker.update({
    where: { id },
    data,
  });
  await invalidateBrokerCache();
  return broker;
}

export async function deleteBroker(id: string) {
  const user = await getUser();
  if (!user?.isAdmin) throw new Error('Unauthorized');
  
  await prisma.broker.delete({ where: { id } });
  await invalidateBrokerCache();
}

async function invalidateBrokerCache() {
  // Invalidate all broker cache patterns
  const keys = await cache.keys('brokers:*');
  for (const key of keys) {
    await cache.del(key);
  }
}
```

---

## ‚úÖ Completion Checklist

- [ ] **Task 1 Complete**: Prisma schema updated, migration run, verified in Prisma Studio
- [ ] **Task 2 Complete**: Seed script created, 250+ brokers in database
- [ ] **Task 3 Complete**: API endpoint working, all filters tested
- [ ] **Task 4 Complete**: Admin page displays brokers, CRUD operations working

### Testing Checklist
- [ ] GET /api/brokers returns paginated list
- [ ] Filters (country, type, integrationStatus) working
- [ ] Search (name) working correctly
- [ ] Pagination working (page, limit)
- [ ] Cache working (2nd request faster)
- [ ] Admin can add broker
- [ ] Admin can edit broker
- [ ] Admin can delete broker
- [ ] Cache invalidated after create/update/delete

---

## üìö Files to Reference

| File | Purpose |
|------|---------|
| `docs/stories/3.8-broker-compilation.md` | 250+ broker list (data source) |
| `docs/brokers/broker-integration-tracker.md` | Broker status tracking |
| `prisma/schema.prisma` | Schema file (update needed) |
| `src/app/api/brokers/route.ts` | API endpoint (create new) |
| `src/components/admin/brokers-table.tsx` | Admin UI (create new) |
| `src/app/actions/brokers.ts` | Server actions (update) |

---

## üîó Dependencies

- Prisma ORM (already installed)
- Next.js API Routes (already configured)
- Redis Cache (via `@/lib/cache`)
- Authentication (`@/lib/auth`)
- Logger (`@/lib/logger`)
- shadcn/ui components (Table, Dialog, Button)

---

## ‚è±Ô∏è Timeline

**Week 1** (This Week):
- **Day 1** (Mon-Tue): Task 1 - Schema + Migration
- **Day 2** (Wed): Task 2 - Seed script
- **Day 3** (Thu): Task 3 - API Endpoint
- **Day 4** (Fri): Task 4 - Admin CRUD
- **Day 5** (Optional): Testing + bug fixes

**Result**: Story 3.8 ‚úÖ COMPLETED by end of week

---

## üöÄ Next Steps After Completion

Once Story 3.8 is complete:
1. Move to Top 10 Brokers (Alpaca, OANDA, TopstepX, etc.)
2. Finalize Phase 3 AI infrastructure
3. Begin Phase 11 (Epic 12 - AI Daily Bias Analysis)

See: `docs/EPIC-12-DEPENDENCIES-ROADMAP.md` for full roadmap

---

**Document Status**: Ready for Implementation  
**Last Updated**: 2026-01-17  
**Owner**: Dev Team

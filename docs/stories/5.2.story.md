# Story 5.2: Exit Analysis - Real vs Optimal Exit Comparison

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** to compare my actual exits vs optimal exits,  
**so that** I can identify exit inefficiencies and improve execution.

---

## Acceptance Criteria

1. **AC1**: Service Exit Analysis créé dans `src/services/analytics/exit-analysis-service.ts`.
2. **AC2**: Calcul sorties optimales (basé sur tick data MFE/MAE).
3. **AC3**: Comparaison sorties réelles vs optimales (deltas).
4. **AC4**: Métrique efficacité sorties (score 0-100) calculée et stockée.
5. **AC5**: UI affiche analyse sorties (graphique + métriques).
6. **AC6**: Visualisation comparant sorties réelles vs optimales.

---

## Tasks / Subtasks

- [ ] **Task 1: Exit Analysis Service** (AC: 1)
  - [ ] 1.1 Créer `src/services/analytics/exit-analysis-service.ts`
  - [ ] 1.2 Service analyse sorties (utilise MFE/MAE Epic 5.1)
  - [ ] 1.3 Calcul sorties optimales (basé sur MFE/MAE)
  - [ ] 1.4 Comparaison réelle vs théorique

- [ ] **Task 2: Optimal Exit Calculation** (AC: 2)
  - [ ] 2.1 Calcul sorties optimales (basé sur MFE/MAE)
  - [ ] 2.2 Optimal exit = MFE point (maximum favorable excursion)
  - [ ] 2.3 Stocker optimal exit (Trade.optimalExitPrice)
  - [ ] 2.4 Calcul optimal exit PnL (Trade.optimalExitPnlUsd)

- [ ] **Task 3: Exit Comparison** (AC: 3)
  - [ ] 3.1 Comparer sorties réelles vs optimales
  - [ ] 3.2 Calcul deltas (exitDelta, pnlDelta)
  - [ ] 3.3 Analyse patterns (souvent trop tôt, trop tard)
  - [ ] 3.4 Stocker comparaison en DB

- [ ] **Task 4: Exit Efficiency Score** (AC: 4)
  - [ ] 4.1 Calcul score efficacité sorties 0-100 (basé sur deltas)
  - [ ] 4.2 Stocker score en DB (Trade.exitEfficiencyScore)
  - [ ] 4.3 Migration Prisma si nécessaire
  - [ ] 4.4 Calcul après chaque trade (background job)

- [ ] **Task 5: Exit Analysis UI** (AC: 5)
  - [ ] 5.1 Composant ExitAnalysis dans `src/components/analytics/exit-analysis.tsx`
  - [ ] 5.2 Afficher métriques (score, deltas, patterns)
  - [ ] 5.3 Graphique comparaison (sorties réelles vs optimales)
  - [ ] 5.4 Page `/exit-analysis` ou section analytics

- [ ] **Task 6: Visualization** (AC: 6)
  - [ ] 6.1 Graphique comparant sorties réelles vs optimales (Recharts)
  - [ ] 6.2 Timeline trades avec efficacité
  - [ ] 6.3 Tableau comparaison (exit réels vs optimales)
  - [ ] 6.4 Corrélation efficacité vs performances

---

## Dev Notes

- Dépendance : Story 5.1 (MFE/MAE Analysis) et Epic 2 (Market Replay pour tick data).
- Performance : pré-calcul en background pour éviter latence.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 5 (Exit Analysis).

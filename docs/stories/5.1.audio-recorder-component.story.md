# Story 5.1: Composant Enregistrement Audio

## Status
Ready for Review

## Story

**As a** trader utilisant l'application,
**I want** un composant d'enregistrement audio intégré à la page de détail d'un trade,
**so that** je puisse capturer mes réflexions vocales immédiatement après un trade sans quitter l'interface.

## Acceptance Criteria

1. Un bouton microphone est visible sur la page de détail du trade (`/trades/[id]`)
2. Cliquer sur le bouton démarre l'enregistrement audio avec indicateur visuel (animation pulsante rouge)
3. Un compteur de durée s'affiche pendant l'enregistrement (format MM:SS)
4. L'utilisateur peut mettre en pause et reprendre l'enregistrement
5. L'utilisateur peut arrêter l'enregistrement via un bouton dédié
6. Une prévisualisation audio est affichée après l'arrêt (waveform + player)
7. L'utilisateur peut supprimer l'enregistrement et recommencer
8. L'utilisateur peut valider l'enregistrement pour le sauvegarder
9. Le fichier audio est uploadé en format webm/opus (ou mp3 fallback)
10. L'upload affiche une progress bar et gère les erreurs réseau
11. Les notes vocales sauvegardées sont listées sur la page du trade
12. Le composant demande la permission microphone et gère le refus gracieusement
13. Le composant fonctionne sur desktop (Chrome, Firefox, Safari) et mobile (iOS Safari, Chrome Android)

## Tasks / Subtasks

- [x] **Task 1: Setup AudioRecorder Hook** (AC: 2, 3, 4, 5, 12)
  - [x] Créer `src/hooks/use-audio-recorder.ts`
  - [x] Implémenter `requestMicrophonePermission()` avec gestion des erreurs
  - [x] Implémenter `startRecording()` avec MediaRecorder API
  - [x] Implémenter `pauseRecording()` / `resumeRecording()`
  - [x] Implémenter `stopRecording()` retournant un Blob audio
  - [x] Gérer le compteur de durée avec `setInterval`
  - [x] Exposer les états: `isRecording`, `isPaused`, `duration`, `audioBlob`, `error`
  - [x] Ajouter fallback pour navigateurs sans support MediaRecorder

- [x] **Task 2: Créer composant AudioRecorderButton** (AC: 1, 2, 3)
  - [x] Créer `src/components/audio/audio-recorder-button.tsx`
  - [x] UI: Bouton microphone avec icône Lucide `Mic`
  - [x] Animation pulsante quand `isRecording` (Tailwind `animate-pulse` + ring rouge)
  - [x] Afficher compteur MM:SS à côté du bouton pendant enregistrement
  - [x] Boutons Pause/Stop apparaissent quand enregistrement actif

- [x] **Task 3: Créer composant AudioPreview** (AC: 6, 7, 8)
  - [x] Créer `src/components/audio/audio-preview.tsx`
  - [x] Générer waveform visuelle avec Web Audio API `AnalyserNode`
  - [x] Player HTML5 audio avec contrôles play/pause/seek
  - [x] Boutons: "Supprimer" (poubelle) et "Sauvegarder" (check)
  - [x] Callbacks: `onSave(blob)`, `onDiscard()`

- [x] **Task 4: Créer VoiceNote Model Prisma** (AC: 11)
  - [x] Ajouter modèle `VoiceNote` dans `prisma/schema.prisma`
  - [x] Champs: `id`, `tradeId`, `userId`, `filePath`, `duration`, `transcription?`, `summary?`, `createdAt`
  - [x] Relation avec `Trade` (many-to-one)
  - [x] Générer migration: `npx prisma migrate dev --name add_voice_notes`

- [x] **Task 5: API Upload Audio** (AC: 9, 10)
  - [x] Créer `src/app/api/voice-notes/upload/route.ts`
  - [x] Valider token Supabase dans request
  - [x] Accepter multipart/form-data avec fichier audio + tradeId
  - [x] Valider format (webm, mp3, ogg, m4a) et taille max (50MB)
  - [x] Sauvegarder dans `public/uploads/voice-notes/{tradeId}/{uuid}.webm`
  - [x] Créer enregistrement `VoiceNote` en DB
  - [x] Retourner `{ id, filePath, duration }`

- [x] **Task 6: Intégration page Trade Detail** (AC: 1, 11)
  - [x] Modifier `src/app/(dashboard)/trades/[id]/trade-detail-content.tsx`
  - [x] Ajouter section "Notes Vocales" sous la section notes textuelles
  - [x] Afficher `AudioRecorderButton` + `AudioPreview` (si blob existe)
  - [x] Lister les `VoiceNote` existantes avec player individuel
  - [x] Permettre suppression d'une note vocale

- [x] **Task 7: Actions Server CRUD VoiceNotes** (AC: 11)
  - [x] Créer `src/app/actions/voice-notes.ts`
  - [x] `getVoiceNotes(tradeId)` - Liste des notes d'un trade
  - [x] `deleteVoiceNote(id)` - Supprime fichier + DB entry (avec vérification ownership)

- [x] **Task 8: Tests et compatibilité** (AC: 13)
  - [x] Créer tests unitaires: 13 tests pour use-audio-recorder
  - [ ] Tests manuels: Chrome desktop
  - [ ] Tests manuels: Firefox desktop
  - [ ] Tests manuels: Safari desktop (Mac)
  - [ ] Tests manuels: iOS Safari (mobile)
  - [ ] Tests manuels: Chrome Android
  - [x] Documenter limitations connues dans Dev Notes

## Dev Notes

### Technologies et APIs

**Web Audio API / MediaRecorder:**
- `navigator.mediaDevices.getUserMedia({ audio: true })` pour accès micro
- `MediaRecorder` API pour enregistrement (format: `audio/webm;codecs=opus`)
- Fallback `audio/mp4` pour Safari iOS si webm non supporté
- Support navigateurs: Chrome 49+, Firefox 25+, Safari 14.1+, Edge 79+

**Structure fichiers:**
```
src/
├── hooks/
│   └── use-audio-recorder.ts       # Hook React pour MediaRecorder
├── components/
│   └── audio/
│       ├── index.ts                # Barrel exports
│       ├── audio-recorder-button.tsx
│       ├── audio-preview.tsx
│       └── audio-waveform.tsx      # (optionnel) visualisation
├── app/
│   ├── api/
│   │   └── voice-notes/
│   │       └── upload/
│   │           └── route.ts
│   └── actions/
│       └── voice-notes.ts
```

### Modèle Prisma VoiceNote

```prisma
model VoiceNote {
  id            String   @id @default(uuid()) @db.Uuid
  tradeId       String   @db.Uuid
  userId        String   @db.Uuid
  filePath      String
  duration      Int      // secondes
  transcription String?  // Rempli par story 5.2
  summary       String?  // Rempli par story 5.3
  createdAt     DateTime @default(now())
  trade         Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@index([userId])
  @@map("voice_notes")
}
```

**Ajouter relation dans Trade:**
```prisma
model Trade {
  // ... existing fields
  voiceNotes    VoiceNote[]
}
```

**Ajouter relation dans User:**
```prisma
model User {
  // ... existing fields
  voiceNotes    VoiceNote[]
}
```

### UI/UX Guidelines

- **Couleur micro inactif:** `text-muted-foreground`
- **Couleur micro actif:** `text-red-500` avec `animate-pulse`
- **Waveform:** Barres verticales animées (style minimaliste)
- **Progress upload:** Utiliser composant `Progress` de shadcn/ui

### Traductions requises (i18n)

```json
// messages/fr.json
{
  "voiceNotes": {
    "title": "Notes vocales",
    "record": "Enregistrer",
    "recording": "Enregistrement...",
    "pause": "Pause",
    "resume": "Reprendre",
    "stop": "Arrêter",
    "preview": "Prévisualisation",
    "save": "Sauvegarder",
    "discard": "Supprimer",
    "delete": "Supprimer cette note",
    "deleteConfirm": "Supprimer cette note vocale ?",
    "uploading": "Upload en cours...",
    "uploaded": "Note vocale sauvegardée",
    "error": {
      "microphoneDenied": "Accès au microphone refusé",
      "notSupported": "Enregistrement audio non supporté sur ce navigateur",
      "uploadFailed": "Échec de l'upload"
    }
  }
}
```

### Limites connues

- **iOS Safari:** Requiert interaction utilisateur pour démarrer l'audio
- **Firefox:** Pas de support natif pause/resume MediaRecorder (workaround: stop + concatenate)
- **Durée max recommandée:** 10 minutes (fichiers > 50MB rejetés)

## Testing

**Emplacement tests:** `src/hooks/__tests__/use-audio-recorder.test.ts`

**Tests unitaires:**
- Mock `navigator.mediaDevices.getUserMedia`
- Test états: idle → recording → paused → stopped
- Test génération blob audio
- Test gestion erreur permission refusée

**Tests d'intégration (manuels):**
- Enregistrer 30 secondes sur chaque navigateur cible
- Vérifier playback du fichier uploadé
- Vérifier persistance après refresh page

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-07 | 0.1 | Draft initial | SM Agent (Bob) |
| 2026-01-07 | 0.2 | Approved après validation PO | PO Agent (Sarah) |
| 2026-01-07 | 1.0 | Implementation complete - Ready for Review | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (Dev Agent - James)

### Debug Log References
- Tests: `npm run test -- --run` → 147/147 passed (includes 13 new audio recorder tests)
- TypeScript: No errors in new audio files
- Migration SQL created manually (DB connection not available in dev environment)

### Completion Notes List
1. Hook `use-audio-recorder.ts` implements full MediaRecorder lifecycle with auto-stop at 10min
2. Components created: `AudioRecorderButton`, `AudioPreview`, `VoiceNotesSection`
3. Prisma model `VoiceNote` added with relations to `Trade` and `User`
4. Migration SQL file created: `20260107230000_add_voice_notes`
5. API route `/api/voice-notes/upload` handles multipart upload with auth
6. Server actions for CRUD with ownership verification
7. i18n translations added for FR and EN
8. Added `@testing-library/react`, `@testing-library/dom`, `jsdom` as dev dependencies
9. Added `uuid`, `@types/uuid` for unique filename generation
10. Audio MIME types added to existing uploads route

### File List

**Created:**
- `src/hooks/use-audio-recorder.ts` - React hook for MediaRecorder API
- `src/hooks/__tests__/use-audio-recorder.test.ts` - 13 unit tests
- `src/components/audio/index.ts` - Barrel exports
- `src/components/audio/audio-recorder-button.tsx` - Recording button component
- `src/components/audio/audio-preview.tsx` - Audio preview with waveform
- `src/components/audio/voice-notes-section.tsx` - Voice notes list & recorder
- `src/app/api/voice-notes/upload/route.ts` - Upload API endpoint
- `src/app/actions/voice-notes.ts` - Server actions for CRUD
- `prisma/migrations/20260107230000_add_voice_notes/migration.sql` - DB migration

**Modified:**
- `prisma/schema.prisma` - Added VoiceNote model + relations
- `src/app/(dashboard)/trades/[id]/page.tsx` - Fetch voice notes
- `src/app/(dashboard)/trades/[id]/trade-detail-content.tsx` - Integrate VoiceNotesSection
- `src/app/api/uploads/[...path]/route.ts` - Added audio MIME types
- `messages/fr.json` - Added voiceNotes translations
- `messages/en.json` - Added voiceNotes translations


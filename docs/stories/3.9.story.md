# Story 3.9: Dynamic Broker Dropdown - Load from API

## Status

**✅ COMPLETED**

**Created**: 2026-01-17  
**Completed**: 2026-01-17  
**Assigned**: Dev Team (James)  
**Duration**: 1.5h (25% faster than estimated)

---

## Story

**As a** user,  
**I want** to see all available API-integrated brokers in the connection dropdown,  
**so that** I can connect to any supported broker dynamically.

---

## Acceptance Criteria

1. **AC1**: Dropdown loads brokers from `/api/brokers` API endpoint
2. **AC2**: Only shows brokers with `integrationStatus: API` and `isActive: true`
3. **AC3**: Broker names mapped correctly to `BrokerType` enum values
4. **AC4**: Dropdown shows broker display name or name from database
5. **AC5**: Handles loading states and errors gracefully
6. **AC6**: Maintains existing broker connection flow

---

## Context

### Problem

The broker connection dropdown on `/brokers` page currently has a hardcoded list (IBKR, TRADOVATE) instead of loading dynamically from the Broker database. This means:

- New API-integrated brokers are not shown until code is updated
- Users cannot see all available brokers
- Manual maintenance required for each new broker integration

### Current State

- Story 3.8 completed: 263 brokers in database, 11 with `integrationStatus: API`
- `/api/brokers` endpoint exists and works correctly
- Broker `isActive` status fixed: only API brokers are active
- Dropdown component uses hardcoded `SelectItem` components

### Solution

Load brokers dynamically from `/api/brokers` endpoint and map `Broker.name` values to `BrokerType` enum for the connection form.

---

## Tasks / Subtasks

- [x] **Task 1: Create Broker Name to BrokerType Mapping** ✅
  - [x] 1.1 Create mapping function `brokerNameToBrokerType()` (`src/lib/broker-mapping.ts`)
  - [x] 1.2 Map all API brokers (Interactive Brokers → IBKR, Alpaca → ALPACA, OANDA, TradeStation, TopstepX, etc.)
  - [x] 1.3 Handle unmapped brokers gracefully (returns null, filtered out)

- [x] **Task 2: Load Brokers from API in Component** ✅
  - [x] 2.1 Add `useEffect` to fetch brokers on component mount
  - [x] 2.2 Filter by `integrationStatus=API` and `isActive=true`
  - [x] 2.3 Handle loading and error states
  - [x] 2.4 Store brokers in component state

- [x] **Task 3: Update Dropdown to Use Dynamic List** ✅
  - [x] 3.1 Replace hardcoded `SelectItem` with mapped broker list
  - [x] 3.2 Display broker `displayName` or `name` from database
  - [x] 3.3 Maintain existing form behavior (onValueChange, etc.)
  - [x] 3.4 Show loading state while fetching

- [x] **Task 4: Testing** ✅
  - [x] 4.1 Test dropdown shows all API brokers (11 brokers with API integration)
  - [x] 4.2 Test broker selection works correctly
  - [x] 4.3 Test loading and error states (fallback to default brokers)
  - [x] 4.4 Test unmapped brokers are filtered out

---

## Technical Notes

### Broker Name to BrokerType Mapping

The mapping needs to convert `Broker.name` (from database) to `BrokerType` enum:

```typescript
const brokerNameToType: Record<string, BrokerType> = {
  'Interactive Brokers': 'IBKR',
  'Tradovate': 'TRADOVATE',
  'Alpaca': 'ALPACA',
  'OANDA': 'OANDA',
  'TradeStation': 'TRADESTATION',
  'TopstepX': 'TOPSTEPX',
  // ... more mappings
};
```

### API Query

Fetch brokers with:
- `integrationStatus=API`
- `isActive=true`
- `limit=100` (to get all API brokers)

### Component Changes

Update `src/app/(dashboard)/brokers/brokers-content.tsx`:
- Add `useState` for brokers list
- Add `useEffect` to fetch from `/api/brokers`
- Map broker names to `BrokerType` before displaying
- Replace hardcoded `SelectItem` with dynamic list

---

## Files to Modify

1. `src/app/(dashboard)/brokers/brokers-content.tsx` - Main component with dropdown
2. `src/lib/broker-mapping.ts` - NEW: Broker name to BrokerType mapping utility

---

## Dev Notes

- Keep existing `BROKER_INFO` constant for backward compatibility (used for logos/descriptions)
- The mapping function should be case-insensitive or normalized
- Consider adding a `brokerType` field to the `Broker` model in the future for direct mapping

---

## Dependencies

- Story 3.8 (Broker Database) - ✅ Completed
- `/api/brokers` endpoint - ✅ Exists and working
- Broker `isActive` status fix - ✅ Completed

---

## Acceptance Test

1. Navigate to `/brokers` page
2. Click "Connect Broker" button
3. Verify dropdown shows all 11 API brokers (IBKR, Tradovate, Alpaca, OANDA, TradeStation, TopstepX, etc.)
4. Select a broker and verify form populates correctly
5. Complete connection flow successfully

---

**Status**: ✅ COMPLETED  
**Started**: 2026-01-17  
**Completed**: 2026-01-17  
**Developer**: James (Dev Agent)

## Completion Summary

### Files Created
- `src/lib/broker-mapping.ts` - Broker name to BrokerType mapping utility (100+ lines)
- `docs/stories/3.9.story.md` - Story documentation

### Files Modified
- `src/app/(dashboard)/brokers/brokers-content.tsx` - Updated dropdown to load dynamically from API

### Key Features
- ✅ Dynamic broker loading from `/api/brokers` endpoint
- ✅ Mapping from `Broker.name` to `BrokerType` enum
- ✅ Loading and error states handled
- ✅ Unmapped brokers filtered out gracefully
- ✅ Maintains existing form behavior

### Testing
- ✅ Dropdown shows all 11 API brokers (IBKR, Tradovate, Alpaca, OANDA, TradeStation, TopstepX, etc.)
- ✅ Broker selection works correctly
- ✅ Loading state displays while fetching
- ✅ Fallback to default brokers if API fails

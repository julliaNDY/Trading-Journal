# Story 3.3: Broker Sync Architecture - Multi-Provider Abstraction

## Status

**Completed** ✅ (2026-01-17)

---

## Story

**As a** platform engineer,  
**I want** a robust broker sync architecture supporting multiple providers,  
**so that** we can integrate 240+ brokers efficiently.

---

## Acceptance Criteria

1. **AC1**: Architecture broker sync extensible (abstraction `BrokerProvider`).
2. **AC2**: Interface `BrokerProvider` définie dans `src/services/broker/types.ts`.
3. **AC3**: Factory pattern pour instancier providers (Tradovate, IBKR, etc.).
4. **AC4**: Error handling robuste (retry, backoff, logging).
5. **AC5**: Rate limiting par broker (respecter limites API).
6. **AC6**: Documentation architecture (patterns, ajout nouveau provider).

---

## Tasks / Subtasks

- [x] **Task 1: BrokerProvider Interface** (AC: 2) ✅
  - [x] 1.1 Vérifier interface `BrokerProvider` existe (src/services/broker/types.ts)
  - [x] 1.2 Méthodes : authenticate, getAccounts, getTrades, refreshToken
  - [x] 1.3 Types : BrokerCredentials, BrokerTrade, AuthResult
  - [x] 1.4 Documenter interface

- [x] **Task 2: Factory Pattern** (AC: 3) ✅
  - [x] 2.1 Factory function `getBrokerProvider(brokerType)` dans `src/services/broker/provider-factory.ts`
  - [x] 2.2 Support Tradovate, IBKR (déjà existants)
  - [x] 2.3 Extensible pour futurs providers (registry-based, metadata)

- [x] **Task 3: Error Handling** (AC: 4) ✅
  - [x] 3.1 Retry logic avec exponential backoff (`error-handler.ts`)
  - [x] 3.2 Error types (BrokerAuthError, BrokerAPIError, etc.)
  - [x] 3.3 Logging structuré (erreurs, stats sync)
  - [x] 3.4 Gestion timeout (withTimeout utility)

- [x] **Task 4: Rate Limiting** (AC: 5) ✅
  - [x] 4.1 Rate limiting par broker (Redis) (`rate-limiter.ts`)
  - [x] 4.2 Configuration limites par provider (BROKER_RATE_LIMITS)
  - [x] 4.3 Queue jobs si limite atteinte (BrokerRateLimitError)
  - [x] 4.4 Respecter retry-after headers (retryAfterMs)

- [x] **Task 5: Documentation** (AC: 6) ✅
  - [x] 5.1 Documenter architecture (README.md dans src/services/broker/)
  - [x] 5.2 Guide ajout nouveau provider (NEW_PROVIDER_GUIDE.md)
  - [x] 5.3 Patterns (factory, error handling, rate limiting)

---

## Implementation Summary

### Files Created

1. **`src/services/broker/error-handler.ts`** (370 lines)
   - Retry logic with exponential backoff
   - Error classification system
   - Timeout handling
   - Circuit breaker pattern
   - Broker-specific retry configs

2. **`src/services/broker/rate-limiter.ts`** (290 lines)
   - Redis-based rate limiting (sliding window)
   - Per-broker and per-account limits
   - In-memory fallback
   - Rate limit status tracking
   - Respects Retry-After headers

3. **`src/services/broker/provider-factory.ts`** (250 lines)
   - Registry-based provider management
   - Provider metadata system
   - Configuration validation
   - Capability queries
   - Easy extensibility

4. **`src/services/broker/README.md`** (1000+ lines)
   - Architecture overview
   - Component documentation
   - Adding new brokers guide
   - Best practices
   - Examples and troubleshooting

5. **`src/services/broker/NEW_PROVIDER_GUIDE.md`** (600+ lines)
   - Step-by-step checklist
   - Code templates
   - Common pitfalls
   - Testing checklist

### Files Modified

1. **`src/services/broker/index.ts`**
   - Added exports for new modules
   - Organized exports by category

2. **`src/services/broker/broker-sync-service.ts`**
   - Integrated error handling (withRetry)
   - Integrated rate limiting (createRateLimiter)
   - Replaced inline factory with provider-factory
   - Enhanced logging

### Key Features Implemented

✅ **AC1 - Extensible Architecture**
- Strategy pattern with BrokerProvider interface
- Registry-based factory for easy extension
- Metadata system for broker capabilities

✅ **AC2 - BrokerProvider Interface**
- Already existed in `types.ts`
- Verified completeness (authenticate, getAccounts, getTrades, refreshToken)
- Error types (BrokerAuthError, BrokerRateLimitError, BrokerApiError)

✅ **AC3 - Factory Pattern**
- Registry-based provider factory
- Metadata management (auth type, rate limits, capabilities)
- Configuration validation
- Easy to add new brokers

✅ **AC4 - Error Handling**
- Exponential backoff with jitter (prevents thundering herd)
- Configurable retry policies per broker
- Timeout handling (withTimeout)
- Error classification for user feedback
- Circuit breaker pattern (optional)
- Structured logging

✅ **AC5 - Rate Limiting**
- Redis-based (distributed, scales horizontally)
- Sliding window algorithm (accurate)
- Per-broker and per-account limits
- In-memory fallback (if Redis unavailable)
- Respects Retry-After headers
- Rate limit status tracking

✅ **AC6 - Documentation**
- Comprehensive README (1000+ lines)
- Quick start guide for new providers
- Architecture diagrams
- Best practices
- Examples and troubleshooting

### Architecture Highlights

**Design Patterns:**
- Strategy Pattern (BrokerProvider interface)
- Factory Pattern (provider-factory)
- Circuit Breaker (error-handler)
- Sliding Window (rate-limiter)

**Reliability:**
- Automatic retry with exponential backoff
- Rate limiting to respect broker API limits
- Timeout handling
- Error classification
- Structured logging

**Scalability:**
- Redis-based rate limiting (distributed)
- Per-account limits (parallel syncs)
- In-memory fallback (graceful degradation)

**Observability:**
- Structured logging with brokerLogger
- Error classification for monitoring
- Rate limit status tracking
- Sync duration metrics

### Testing

- Integration with existing Tradovate and IBKR providers
- Error handling tested with retry logic
- Rate limiting tested with Redis
- Documentation includes testing checklist

### Next Steps

- Story 3.4: Integrate 50+ priority brokers
- Story 3.5: Scheduler & auto-sync
- Story 3.6: Broker connections UI

---

## Dev Notes

- Architecture déjà partiellement implémentée (Tradovate, IBKR existants).
- Vérifier code existant dans `src/services/broker/` avant création.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Architecture broker sync).
- ⚠️ **CRITIQUE** : Notification immédiate PM requise pour chaque nouveau broker (governance rules).
- Référencer `docs/architecture-trading-path-journal.md` Section 2 (Broker Sync).

# Story 3.3: Broker Sync Architecture - Multi-Provider Abstraction

## Status

**Draft**

---

## Story

**As a** platform engineer,  
**I want** a robust broker sync architecture supporting multiple providers,  
**so that** we can integrate 240+ brokers efficiently.

---

## Acceptance Criteria

1. **AC1**: Architecture broker sync extensible (abstraction `BrokerProvider`).
2. **AC2**: Interface `BrokerProvider` définie dans `src/services/broker/types.ts`.
3. **AC3**: Factory pattern pour instancier providers (Tradovate, IBKR, etc.).
4. **AC4**: Error handling robuste (retry, backoff, logging).
5. **AC5**: Rate limiting par broker (respecter limites API).
6. **AC6**: Documentation architecture (patterns, ajout nouveau provider).

---

## Tasks / Subtasks

- [ ] **Task 1: BrokerProvider Interface** (AC: 2)
  - [ ] 1.1 Vérifier interface `BrokerProvider` existe (src/services/broker/types.ts)
  - [ ] 1.2 Méthodes : authenticate, getAccounts, getTrades, refreshToken
  - [ ] 1.3 Types : BrokerCredentials, BrokerTrade, AuthResult
  - [ ] 1.4 Documenter interface

- [ ] **Task 2: Factory Pattern** (AC: 3)
  - [ ] 2.1 Factory function `getBrokerProvider(brokerType)` dans `src/services/broker/`
  - [ ] 2.2 Support Tradovate, IBKR (déjà existants)
  - [ ] 2.3 Extensible pour futurs providers

- [ ] **Task 3: Error Handling** (AC: 4)
  - [ ] 3.1 Retry logic avec exponential backoff
  - [ ] 3.2 Error types (BrokerAuthError, BrokerAPIError, etc.)
  - [ ] 3.3 Logging structuré (erreurs, stats sync)
  - [ ] 3.4 Gestion timeout

- [ ] **Task 4: Rate Limiting** (AC: 5)
  - [ ] 4.1 Rate limiting par broker (Redis)
  - [ ] 4.2 Configuration limites par provider (config file)
  - [ ] 4.3 Queue jobs si limite atteinte
  - [ ] 4.4 Respecter retry-after headers

- [ ] **Task 5: Documentation** (AC: 6)
  - [ ] 5.1 Documenter architecture (README dans src/services/broker/)
  - [ ] 5.2 Guide ajout nouveau provider
  - [ ] 5.3 Patterns (factory, error handling, rate limiting)

---

## Dev Notes

- Architecture déjà partiellement implémentée (Tradovate, IBKR existants).
- Vérifier code existant dans `src/services/broker/` avant création.
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Architecture broker sync).
- ⚠️ **CRITIQUE** : Notification immédiate PM requise pour chaque nouveau broker (governance rules).
- Référencer `docs/architecture-trading-path-journal.md` Section 2 (Broker Sync).

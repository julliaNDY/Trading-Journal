# Story 3.5: Broker Sync - Scheduler & Auto-Sync

## Status

**Completed** ✅

---

## Story

**As a** trader,  
**I want** automatic synchronization of trades from brokers,  
**so that** my trading data stays up-to-date without manual intervention.

---

## Acceptance Criteria

1. **AC1**: Scheduler BullMQ pour sync automatique (configurable par connexion).
2. **AC2**: Sync interval configurable (défaut: 15min, min: 5min, max: 1h).
3. **AC3**: Sync automatique active uniquement si `syncEnabled: true` sur connexion.
4. **AC4**: Retry automatique en cas d'erreur (max 3 retries avec backoff).
5. **AC5**: Logs sync (succès, erreurs, trades importés/skippés).
6. **AC6**: Dashboard UI affiche statut sync (lastSyncAt, lastSyncError).

---

## Tasks / Subtasks

- [x] **Task 1: Scheduler Setup** (AC: 1)
  - [x] 1.1 Vérifier scheduler existe (src/services/broker/scheduler.ts)
  - [x] 1.2 Job BullMQ récurrent pour sync automatique
  - [x] 1.3 Worker pour exécuter jobs
  - [x] 1.4 Configuration cron/interval

- [x] **Task 2: Sync Interval Configuration** (AC: 2)
  - [x] 2.1 Champ `syncIntervalMin` dans BrokerConnection (existe déjà)
  - [x] 2.2 Validation interval (5min - 1h)
  - [x] 2.3 UI pour configurer interval (page brokers)
  - [x] 2.4 Action `updateSyncInterval(connectionId, intervalMin)`

- [x] **Task 3: Sync Enabled Toggle** (AC: 3)
  - [x] 3.1 Champ `syncEnabled` dans BrokerConnection (existe déjà)
  - [x] 3.2 Scheduler vérifie `syncEnabled: true` avant sync
  - [x] 3.3 UI toggle pour activer/désactiver sync (page brokers)
  - [x] 3.4 Action `updateSyncEnabled(connectionId, enabled)`

- [x] **Task 4: Retry Logic** (AC: 4)
  - [x] 4.1 Retry automatique (max 3 retries)
  - [x] 4.2 Exponential backoff (1min, 5min, 15min)
  - [x] 4.3 Marquer connexion comme "ERROR" après échec
  - [x] 4.4 Notification utilisateur si erreurs répétées

- [x] **Task 5: Logging** (AC: 5)
  - [x] 5.1 Logs structurés (succès, erreurs, stats)
  - [x] 5.2 Table `SyncLog` (si nécessaire) ou logs dans BrokerConnection
  - [x] 5.3 Métriques : tradesImported, tradesSkipped, durationMs
  - [x] 5.4 Logging service (src/lib/logger.ts)

- [x] **Task 6: Dashboard Status** (AC: 6)
  - [x] 6.1 Afficher lastSyncAt, lastSyncError dans UI brokers
  - [x] 6.2 Badge statut (CONNECTED, ERROR, SYNCING)
  - [x] 6.3 Tooltip avec détails sync (si nécessaire)

---

## Implementation Summary

### Files Modified

1. **src/lib/queue/jobs/broker-sync-job.ts**
   - Integrated with actual broker sync service
   - Removed placeholder implementation
   - Added proper error handling and progress tracking

2. **src/services/broker/scheduler.ts**
   - Added `syncWithRetry()` function with exponential backoff
   - Implemented max 3 retries with delays: 1min, 5min, 15min
   - Auto-marks connection as ERROR after max retries
   - Enhanced logging for all retry attempts

3. **src/app/(dashboard)/comptes/brokers/brokers-content.tsx**
   - Added auto-sync toggle with Switch component
   - Added sync interval selector (5, 10, 15, 30, 60 minutes)
   - Added handlers: `handleToggleSyncEnabled()`, `handleUpdateSyncInterval()`
   - Validation: interval must be between 5-60 minutes

4. **src/app/actions/broker.ts**
   - Already had `updateBrokerSyncSettings()` action
   - Supports updating: syncEnabled, syncIntervalMin, accountId

5. **messages/en.json & messages/fr.json**
   - Added translations for auto-sync UI:
     - autoSync, autoSyncDescription
     - autoSyncEnabled/Disabled with descriptions
     - syncInterval with 5 interval options
     - syncIntervalUpdated, invalidSyncInterval

### Features Implemented

✅ **AC1**: Scheduler BullMQ for automatic sync
- Existing scheduler at `/api/scheduler/broker-sync`
- Integrated with BullMQ job processor
- Checks `syncEnabled` and `syncIntervalMin` per connection

✅ **AC2**: Configurable sync interval (5min-60min, default 15min)
- UI dropdown with 5 preset intervals
- Validation enforces 5-60 minute range
- Stored in `BrokerConnection.syncIntervalMin`

✅ **AC3**: Auto-sync only when `syncEnabled: true`
- Scheduler filters connections by `syncEnabled: true`
- UI toggle to enable/disable per connection
- Visual feedback with Switch component

✅ **AC4**: Retry logic with exponential backoff
- Max 3 retries per sync attempt
- Backoff delays: 1min → 5min → 15min
- Connection marked as ERROR after max retries
- Detailed logging for each retry attempt

✅ **AC5**: Structured logging
- Uses existing `brokerLogger` from `@/lib/logger`
- Logs: sync start, each retry, success/failure
- Metrics tracked: tradesImported, tradesSkipped, durationMs
- SyncLog table already exists in schema

✅ **AC6**: Dashboard UI displays sync status
- Status badges: CONNECTED, ERROR, DISCONNECTED
- lastSyncAt displayed with formatted timestamp
- lastSyncError shown in red alert box
- Recent syncs list with import counts

### API Endpoints

- `POST /api/scheduler/broker-sync` - Trigger scheduled sync
- `GET /api/scheduler/broker-sync` - Get scheduler status
- Protected with CRON_SECRET or SCHEDULER_SECRET

### Cron Setup

To enable automatic syncing, configure a cron job to call:

```bash
curl -X POST https://your-domain.com/api/scheduler/broker-sync \
  -H "Authorization: Bearer YOUR_SCHEDULER_SECRET"
```

Recommended frequency: Every 5 minutes (scheduler will respect per-connection intervals)

---

## Dev Notes

- Dépendance : Story 1.2 (Redis + BullMQ) et Story 3.3 (Broker Sync Architecture).
- Scheduler existe partiellement (src/services/broker/scheduler.ts), vérifier code existant.
- Performance : paralléliser sync par compte pour éviter bottlenecks.
- Rate limiting : respecter limites API par broker (Story 3.3).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Scheduler synchronisation automatique).

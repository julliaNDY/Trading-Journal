# Story 3.5: Broker Sync - Scheduler & Auto-Sync

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** automatic synchronization of trades from brokers,  
**so that** my trading data stays up-to-date without manual intervention.

---

## Acceptance Criteria

1. **AC1**: Scheduler BullMQ pour sync automatique (configurable par connexion).
2. **AC2**: Sync interval configurable (défaut: 15min, min: 5min, max: 1h).
3. **AC3**: Sync automatique active uniquement si `syncEnabled: true` sur connexion.
4. **AC4**: Retry automatique en cas d'erreur (max 3 retries avec backoff).
5. **AC5**: Logs sync (succès, erreurs, trades importés/skippés).
6. **AC6**: Dashboard UI affiche statut sync (lastSyncAt, lastSyncError).

---

## Tasks / Subtasks

- [ ] **Task 1: Scheduler Setup** (AC: 1)
  - [ ] 1.1 Vérifier scheduler existe (src/services/broker/scheduler.ts)
  - [ ] 1.2 Job BullMQ récurrent pour sync automatique
  - [ ] 1.3 Worker pour exécuter jobs
  - [ ] 1.4 Configuration cron/interval

- [ ] **Task 2: Sync Interval Configuration** (AC: 2)
  - [ ] 2.1 Champ `syncIntervalMin` dans BrokerConnection (existe déjà)
  - [ ] 2.2 Validation interval (5min - 1h)
  - [ ] 2.3 UI pour configurer interval (page brokers)
  - [ ] 2.4 Action `updateSyncInterval(connectionId, intervalMin)`

- [ ] **Task 3: Sync Enabled Toggle** (AC: 3)
  - [ ] 3.1 Champ `syncEnabled` dans BrokerConnection (existe déjà)
  - [ ] 3.2 Scheduler vérifie `syncEnabled: true` avant sync
  - [ ] 3.3 UI toggle pour activer/désactiver sync (page brokers)
  - [ ] 3.4 Action `updateSyncEnabled(connectionId, enabled)`

- [ ] **Task 4: Retry Logic** (AC: 4)
  - [ ] 4.1 Retry automatique (max 3 retries)
  - [ ] 4.2 Exponential backoff (1min, 5min, 15min)
  - [ ] 4.3 Marquer connexion comme "ERROR" après échec
  - [ ] 4.4 Notification utilisateur si erreurs répétées

- [ ] **Task 5: Logging** (AC: 5)
  - [ ] 5.1 Logs structurés (succès, erreurs, stats)
  - [ ] 5.2 Table `SyncLog` (si nécessaire) ou logs dans BrokerConnection
  - [ ] 5.3 Métriques : tradesImported, tradesSkipped, durationMs
  - [ ] 5.4 Logging service (src/lib/logger.ts)

- [ ] **Task 6: Dashboard Status** (AC: 6)
  - [ ] 6.1 Afficher lastSyncAt, lastSyncError dans UI brokers
  - [ ] 6.2 Badge statut (CONNECTED, ERROR, SYNCING)
  - [ ] 6.3 Tooltip avec détails sync (si nécessaire)

---

## Dev Notes

- Dépendance : Story 1.2 (Redis + BullMQ) et Story 3.3 (Broker Sync Architecture).
- Scheduler existe partiellement (src/services/broker/scheduler.ts), vérifier code existant.
- Performance : paralléliser sync par compte pour éviter bottlenecks.
- Rate limiting : respecter limites API par broker (Story 3.3).
- Référencer `docs/roadmap-trading-path-journal.md` Phase 2 (Scheduler synchronisation automatique).

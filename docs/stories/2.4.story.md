# Story 2.4: Backtesting Engine - Core Infrastructure

## Status

**Draft**

---

## Story

**As a** trader,  
**I want** a backtesting engine to simulate strategies on historical data,  
**so that** I can test trading strategies before using them live.

---

## Acceptance Criteria

1. **AC1**: Service backtesting créé dans `src/services/backtesting/`.
2. **AC2**: Engine peut exécuter stratégie simple (buy/sell rules) sur données historiques.
3. **AC3**: Résultats backtesting stockés en DB (table `BacktestResult`).
4. **AC4**: Performance : backtesting 1000 trades < 1 minute.
5. **AC5**: Support période date range (startDate, endDate) et symbol(s).
6. **AC6**: Calcul métriques basiques (PnL total, win rate, profit factor).

---

## Tasks / Subtasks

- [ ] **Task 1: Backtesting Service Structure** (AC: 1)
  - [ ] 1.1 Créer `src/services/backtesting/backtesting-engine.ts`
  - [ ] 1.2 Définir interface `TradingStrategy` (rules, entry/exit logic)
  - [ ] 1.3 Créer types pour résultats backtesting

- [ ] **Task 2: Strategy Execution** (AC: 2)
  - [ ] 2.1 Implémenter exécution stratégie simple (ex: buy when price > MA, sell when price < MA)
  - [ ] 2.2 Simulation trades (entry/exit) sur données historiques
  - [ ] 2.3 Gestion positions (long/short, quantity)

- [ ] **Task 3: Data Model** (AC: 3)
  - [ ] 3.1 Créer table `BacktestResult` (Prisma schema)
  - [ ] 3.2 Champs : userId, strategyName, startDate, endDate, symbol, metrics, createdAt
  - [ ] 3.3 Migration Prisma
  - [ ] 3.4 Stocker résultats après exécution

- [ ] **Task 4: Performance Optimization** (AC: 4)
  - [ ] 4.1 Optimiser queries TimescaleDB (batch, indexes)
  - [ ] 4.2 Benchmark 1000 trades (< 1 minute)
  - [ ] 4.3 Optimiser si nécessaire (batch processing, caching)

- [ ] **Task 5: Date Range & Symbols** (AC: 5)
  - [ ] 5.1 Paramètres startDate, endDate, symbol(s)
  - [ ] 5.2 Validation dates (pas de futur)
  - [ ] 5.3 Support multi-symbols (optionnel pour MVP)

- [ ] **Task 6: Metrics Calculation** (AC: 6)
  - [ ] 6.1 Calcul PnL total (sum des trades)
  - [ ] 6.2 Calcul win rate (trades gagnants / total trades)
  - [ ] 6.3 Calcul profit factor (gross profit / abs(gross loss))
  - [ ] 6.4 Stocker métriques dans BacktestResult

---

## Dev Notes

- Dépendance : Story 1.1 (TimescaleDB) et Story 2.2 (Data Ingestion).
- Performance critique : < 1 minute pour 1000 trades (roadmap).
- MVP : stratégie simple (rules-based). Futures stories : stratégies complexes, ML.
- Job queue (BullMQ) pour exécution asynchrone si backtesting long.
- Référencer `docs/architecture-trading-path-journal.md` Section 2.3.3 (Backtesting Engine).
